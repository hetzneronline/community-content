---
SPDX-License-Identifier: MIT
path: "/tutorials/encrypted-private-nextcloud-VPS-and-storagebox"
slug: "encrypted-private-nextcloud-VPS-and-storagebox"
date: "2025-07-07"
title: "European private nextcloud with fully encrypted storage"
short_description: "This tutorial allows you to set up your own nextcloud following the recommended AIO approach, storing everything encrypted on disk and uses Hetzner's storageBox for cheap storage."
tags: ["Cloud", "Nextcloud", "StorageBox", "encrypted-private-nextcloud-VPS-and-storagebox"]
author: "Justin Scholz"
author_link: "https://github.com/JMoVS"
author_img: "https://avatars3.githubusercontent.com/u/JMoVS"
author_description: "Always striving to hit the right balance."
language: "en"
available_languages: ["en", "Enter all other available languages of the tutorial using ISO 639-1 codes"]
header_img: "header-x"
cta: "product"
---

## Encrypted private cloud setup with 1TB of storage for 6€/month, hosted in Europe

In light of current events - _waves around_ - putting your own private data into a US based cloud, irregardless of whether you are a US citizen or a EU citizen or somewhere else, might not be the most advisable option anymore. Especially if it's not encrypted as it can then be scanned, AI trained on it and many more things. Tools like boxcryptor exist, but I specifically wanted something where I control more of the stack.

So I set out to run my own Nextcloud - pretty much a European open source cloudware that is a bit akin to Google Workspace without email hosting.

What I wanted to achieve:
- low costs
- controllable costs (I want them predictable - not like an AWS bill)
- European data center
- expandable
- fully encrypted (not necessarily end-to-end, but full disk encrypted)
- syncing of files, calendar, contacts and the ability to host my own video calls à la zoom

The setup that I built has now survived a stresstest of 120000 files being synced to it, multiple reboots and so far is running smoothly.

## Overview

- smallest VPS on Hetzner (in their parlance a cloud server) with 4GB of RAM, 2 CPU cores and 40GB of NVME storage. 
- connected to a Hetzner "StorageBox" - which is essentially a 1TB NAS in the cloud for the incredibly low price of 3,81€/month/TB (or even cheaper for more TB).

On this setup, I run a boring Debian system on a fully encrypted disk that requires me to manually enter the encryption key at boot time.

- the nextcloud desktop client for Mac and Windows has support for virtual file systems. This means for me that I can have the best of both world. I can sync some files and folders (like my documents folder) fully and permanently to an arbitrary location on my Macbook. And I additionally also get to have all the other folders that I don't usually sync available on demand through the fileprovider cloud API so I can poke around through folders and download it on demand. Really useful for stuff that I don't need available all the time.

This tutorial will help you set up the system, but it will not guide you on running, maintaining and updating it. It is only concering how to get it up and running and aside from enabling encryption will not cover any nextcloud usage patterns.

## Why I care about encryption

It might not be often but it does happen that law enforcement confiscates physical hardware in a data center for analysis or that people get unauthorised physical access. By making sure that when there is a power cut of some sorts, I have to manually reenter the encryption key, it gives me a chance to decide whether I want to do that or not.
Storing the encryption key at boot is like taping it next to your door outside your house "just ot have it handy all the time".

The nextcloud itself has the server side encryption feature activated and encrypts all files it stores. As the data backend is the storage box, that encrypts the files' contents (it does *not* encrypt the file names, sizes or folder names).

ALL data is always encrypted as it either lands on disk (which is LUKS encrypted) or it lands in the nextcloud data directory on the Storage box, which is encrypted through the nextcloud server side encryption.

I am fully aware that memory is not encrypted and if you are Hetzner and you poke through the RAM of my virtual machine you can probably extract out keymaterial. This is not my threat model. If you want to defend against such a case, don't run your software on someone else's computer in a place you don't control.

## The setup, step by step

Get an account at hetzner.com (sadly not sponsored - @Hetner: I welcome if you reach out to me:D). 

Click yourself a CX22 or some other x86 (!important!) server. The 2CPU version is sufficient. Even only 2 GB can work RAM wise - I will show you how.

Follow this guide: https://community.hetzner.com/tutorials/install-ubuntu-2004-with-full-disk-encryption (and beware of the special section for Debian 12!) with the following caveats:


## Set everything up in the rescue system

When booted into the rescue system, you can check the full name of the Debian image by running
`ls /root/images` and copying the Debian12 image name into your pasteboard. Furthermore, in the setup.conf, specify the "/" filesystem to be btrfs instead of ext4 - your setup.conf should look like this:

```
CRYPTPASSWORD secret
DRIVE1 /dev/sda
BOOTLOADER grub
HOSTNAME host.example.com
PART /boot ext4 1G
PART /     ext4 all crypt
IMAGE /root/images/Debian-1211-bookworm-amd64-base.tar.gz
SSHKEYS_URL /tmp/authorized_keys
```


_Additional notice: If you add private networking it might happen that your Dropbear unlock only picks up the IP from your local network first and is unreachable over ssh. In this case temporarily disable the private network or discuss this issue with your preferred coding AI - the issue is that the private network wins the race of "which network interface responds with an IP address first"._

Once that is setup, you can create yourself a storage box in the same region at Hetzner console. Choose your preferred size. Create a subaccount with limited access to a specific subfolder for your nextcloud and enable SMB access. You DON'T need to enable "external access" though as this stays in the Hetzner network.

## Booting into the VPS

Now you can proceed with setting up your VPS - you can follow this guide for a basic setup: https://community.hetzner.com/tutorials/howto-initial-setup-ubuntu

Let's open the relevant ports on UFW for all the stuff:

```
sudo ufw default deny incoming
sudo ufw default allow outgoing

# HTTP for ACME/Nextcloud challenge
sudo ufw allow 80/tcp comment 'ACME-HTTP-Nextcloud'

# HTTPS for Apache container (HTTP/1.1 & HTTP/2)
sudo ufw allow 443/tcp comment 'Apache-HTTPS'

# HTTP/3 (QUIC) for Apache container
sudo ufw allow 443/udp comment 'Apache-HTTP3-QUIC'

# Admin interface of master container
sudo ufw allow 8443/tcp comment 'Master-UI-HTTPS'

# TURN server (Talk container) – TCP & UDP
sudo ufw allow 3478/tcp comment 'TURN-TCP'
sudo ufw allow 3478/udp comment 'TURN-UDP'
```

Once that is done, you can check your Hetzner console for your ipv4 address (if you ordered one) and ipv6 by entering

```
ip -6 addr show
```

your interface is probably `enp1s0`.

## Pointing your DNS to your server

If you now go to your domain registrar for your own domain, you can adjust the A and the AAAA record for your (sub)domain for your ipv4 and ipv6 addresses respectively.

Once that is done, let's go back to your VPS.

## Back on the Hetzner VPS, let's create the SMB share to the storage box

Go to a root shell `sudo su`. Stay in the root shell during the rest of the guide.

Let's first install SMB support and create a mount point that makes sure it is mounted *before* docker gets started.

```
sudo apt update
sudo apt install cifs-utils
```

```
sudo mkdir -p /mnt/myshare
```
replace "myshare" with whatever you want to call the backing storage for your nextcloud

Let's write the credentials in a file (our disk is encrypted - there might be more beautiful ways - this way works for me):

```
sudo mkdir -p /etc/cifs-creds
sudo nano /etc/cifs-creds/myshare
```

Add:

```
username=your_smb_username
password=your_smb_password
```

This username and password is the username and password from your sub account of your Hetzner StorageBox.

Then we create a systemd .mount unit by running `sudo nano /etc/systemd/system/mnt-myshare.mount`

```
[Unit]
Description=Mount SMB Share myshare
After=network-online.target
Wants=network-online.target
Before=umount.target
Conflicts=umount.target

[Mount]
What=//YOURSTORAGEBOXUSER-subX.your-storagebox.de/YOURSTORAGEBOXUSER-subX
Where=/mnt/myshare
Type=cifs
Options=credentials=/etc/cifs-creds/myshare,iocharset=utf8,uid=33,gid=33,seal,vers=3.1.1,_netdev
TimeoutSec=30
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
```

and let's activate it

```
sudo mkdir -p /mnt/myshare
sudo systemctl daemon-reload
sudo systemctl enable --now mnt-myshare.mount
```

## Install Docker

Now that this is done, you can follow the guide to install Docker: https://docs.docker.com/engine/install/debian/

and now let's make Docker depend on the share mount:

```
sudo systemctl edit docker.service
```

check the comments and now insert *above* the line that says "everything below this line will be ignored":

```
[Unit]
Requires=mnt-myshare.mount
After=mnt-myshare.mount
```

Once that is done, enable ipv6 (we're living in the 21st century for heaven's sake): https://github.com/nextcloud/all-in-one/blob/main/docker-ipv6-support.md

You will not yet be able to check step 3 that it works - that will work later.

## Prepare Nextcloud AIO

Once that is done, I recommend to run nextcloud AIO through compose. This makes it easier to track changes and see what's the starting parameters. In my case, I do:

```
mkdir -p ~/containers/nextcloud
cd ~/containers/nextcloud
nano compose.yml
```

you can perfectly safely start with this compose from AIO: https://github.com/nextcloud/all-in-one/blob/main/compose.yaml?tab=readme-ov-file

I adjusted:
- uncommented environment
- uncommented NEXTCLOUD_DATADIR: and set it to: `NEXTCLOUD_DATADIR: /mnt/myshare` (see https://github.com/nextcloud/all-in-one#how-to-change-the-default-location-of-nextclouds-datadir)
- uncommented NEXTCLOUD_MAX_TIME and doubled it
- uncommented NEXTCLOUD_MEMORY_LIMIT and set it to 2048

## Final preparations - set up swap to help with memory pressure

Before we start running any containers, let's enable Swap on the server so that we don't run out of RAM:

```
fallocate -l 4G /swapfile
dd if=/dev/zero of=/swapfile bs=1M count=4096 status=progress
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
```

let's add it to system boot up:
```
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

and encourage a bit more swapping:
```
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
```

you can verify it worked by checking:
```
htop
```

it should show memory and swap separately. Swap should show "x/4.00G".

_Especially if you are on the 2GB RAM box, 4G of Swap were a good idea when also running fulltext search_

## Let's start it up
Make sure you're in the right directoy:

If you haven't yet adjusted the DNS on your domain registrat to point to your hetzner server, now is the time.

```
cd ~/containers/nextcloud
docker compose up -d
```


Now continuing the guide on https://github.com/nextcloud/all-in-one/blob/main/readme.md, let's open https://your-domain-that-points-to-this-server.tld:8443 and go to your AIO install interface

follow the steps - at the end it will show a temporary password for the user admin that you can then use to login under https://your-domain-that-points-to-this-server.tld:443 with the data store in the back being on your storagebox.

## Once logged in to the Nextcloud, enable encryption

To encrypt all files, you should now head to your user icon on the top right => Admin settings => security settings => server side encryption => switch it on. Then head to user name on the top right => apps => deactivated apps and activate the "default encryption module". Now head back to admin settings=>security settings=>encryption and check that the checkbox is ticked for "encrypt user home folders".

If you want, you can stop your containers, enable fulltextsearch and some other containers. 

## Optional: Enable nextcloud backup to the same storage box

You can also hook up your backup to the same storage box for the backup by:

- creating a new sub account on the storage box with access restricted to a backup folder. This time, only ssh access is needed.

Once you have the new sub account, you can go to the AIO interface and enter your destination as

```
ssh://YOURBOXID-subX@YOURBOXID-subX.your-storagebox.de:23/./nextcloud-aio-borg
```

the "." gets you to the backup sub folder but the additional sub folder is necessary. Don't ask me why.

Before it works, you'll have to add borg's public key to the authorized_keys, which is a bit of a pain because the storage box doesn't even have nano or vi.

To circumvent this, we create the key file by copying from the AIO interface and running 

```
nano authorized_keys
```

and paste it. You can exit nano by pressing ctrl-q and then confirming to save (look at the bottom of the screen).

now let's copy it the box:

```
scp -P 23 authorized_keys     YOURBOXID-subX@YOURBOXID-subX.your-storagebox.de:.ssh/authorized_keys
```

now it should be possible to connect borg.

Last but not least, to make sure that borg doesn't save the data twice, we should add exclusions for the SMB share:

```
touch /mnt/myshare/_data/.noaiobackup
```

Let's check if it worked:

```
ls -la /mnt/myshare/_data/
```

Now let's also add it to the custom_apps directory:

```
touch /mnt/myshare/_data/appdata_*/.noaiobackup
```

Now you should be good to go. For the extended desktop client, there is dropdown next to the download button on https://nextcloud.com/install/#install-clients for "nextcloud files" - choose the version MacOS Virtual files.

## A word about Backups

The borg backups are one thing, you can additionally configure the StorageBox to make automatic snapshots in a regular time interval. On top of that, you can have your Synology (if you have one) sync to a local (likely encrypted shared folder) all your data via the "Cloud Sync" app via WebDAV. You can find the webdav link in your nextcloud in the "files" app on the bottom left by clicking on settings and then selecting webdav.

With this setup, if you want quick access to some large local files, you can work with them on the synology and they will be synced back in your cloud. You can also drop them in the synology to have large uploads work even when your laptop is off or not online. And with the virtual files, you can see everything on demand. With normal folder sync, you can get the basics always to be synced to your laptop.

Last but not least, for good measure, I additionally make a regular backup via Hyperbackup on my synology of the Cloudmirror - in case a ransomware encrypts my cloud and my backups fail at Hetzner, this way I can get back to my data nevertheless.

## Expanding storage

By increasing the storagebox, you directly increase the size of data storage available. If you want to have more compute or internal storage, then you need to shut down your server, rescale it and figure out how to increase the LUKS container size on disk. Let me know if you figure this out - it probably works in the Hetzner rescue system.

## Conclusion

Congratulations, you now have your own private nextcloud with 1TB of storage, easily expandable, fully encrypted and under your control. As next steps you can start using it, set up emails, set up additional backup systems or activate them with Hetzner - enjoy!

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->