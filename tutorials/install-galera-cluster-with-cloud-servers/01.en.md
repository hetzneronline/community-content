---
SPDX-License-Identifier: MIT
path: "/tutorials/install-galera-cluster-with-cloud-servers"
slug: "install-galera-cluster-with-cloud-servers"
date: "2023-01-02"
title: "Build up a MariaDB Galera Cluster in the Hetzner Cloud"
short_description: "I´ll show you how to build up a MariaDB Galera Cluster on Debain 11 inside of the Hetzner Cloud with a loadalancer in front of."
tags: ["Galera", "MariaDB", "Cluster", "Cloud", "Debian"]
author: "tompieger"
author_link: "https://github.com/tompieger"
author_img: "https://avatars.githubusercontent.com/u/112869989?s=400&v=4"
author_description: "Full Stack Software Developer"
language: "en"
available_languages: ["en", "de"]
header_img: "header-2"
cta: "cloud"
---

## Introduction

Sometimes it is useful to have a highly available MariaDB - with a Galera cluster. For this scenario, we put the cluster behind a private load balancer inside the Hetzner Cloud and make the cluster accessible from other cloud servers.

![Operartion-Mode of a Galera Cluster](images/galera_small.png)


**Prerequisites**

- a load-balancer (public IP is disabled)
- 3 Hetzner cloud servers (Debian 11) - or more
- a private network, attached to the load balancer and the MariaDB nodes

Terminology that we use in the tutorial:

* Domain: `example.com`
* IP addresses (IPv4) and Hostnames:
   * Load-balancer: `10.1.0.1`
   * MariaDB Node 1: `10.1.0.2` and `db01.example.com`
   * MariaDB Node 2: `10.1.0.3` and `db02.example.com`
   * MariaDB Node 3: `10.1.0.4` and `db03.example.com`


## Step 1 - Prepare Cloud Servers

After ordering a new cloud server (CX11) with a standard OS Debian 11, log in to the Shell as root user and do a first update of the repo lists:
```shell
apt update
apt upgrade
```


## Step 2 - Install software on the database nodes

The MariaDB project makes it easy to add the MariaDB repo and dependencies with a small shell script.
```shell
curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash
```

After the shell script has added the MariaDB repository url, we could start installing the MariaDB-Server, -Client, Galera4 and backups.
```shell
apt install mariadb-server mariadb-client galera-4 libmariadb3 mariadb-backup -y
```


## Step 3 - Configure MariaDB on the database nodes
On each database node you have to do the same configuration.

Edit the File `/etc/mysql/mariadb.conf.d/50-server.cnf` and put the parameter or comment it out:
```shell
[server]
# Proxy Protokoll Parameter is needed for Access via the load balancer to the database instances:
proxy-protocol-networks=10.1.0.0/24, localhost  # Be aware to set your own private Subnet if other than here!

# While we do a health check from the load balancer our database nodes are in mind, that this checks are unauthenticated connections.
# After 2-3 days the limit counter for error-connections is raised and the cluster is working but don´t accept new connections from our 
# web server or application server because of "Black-Listing".
max_connect_errors    = 4294967295
max_connections       = 100000

# ----------------------- 8< --------------------------
## To allow connections not only on localhost skip off the bind-address parameter.
## For now we accept Connections on the eth0 Address (10.1.0.x)
# bind-address        = 127.0.0.1
# ----------------------- >8 --------------------------
```


## Step 4 - Configure Galera on the database nodes
The easy way is to clear the cnf file for the Galera and put only the needed information inside an empty file:
```shell
echo > /etc/mysql/mariadb.conf.d/60-galera.cnf
```

Now edit the File with nano/vim/....
```shell
nano /etc/mysql/mariadb.conf.d/60-galera.cnf
```

Add the config and put your own parameters if needed:
```
# Galera related Settings
# Read more about the parameters at https://mariadb.com/kb/en/galera-cluster/

[galera]
wsrep_provider            = /usr/lib/galera/libgalera_smm.so
wsrep_on                  = ON                                    # Put the Replication on this Node ON.
wsrep_cluster_name        = "MariaDB Galera Cluster"              # a Name for the Cluster
wsrep_cluster_address     = gcomm://10.1.0.2,10.1.0.3,10.1.0.4    # All IP-Addresses of the Database Nodes including my own Address
wsrep_node_address        = 10.1.0.2                              # my own IP-Address on the private Interface
wsrep_node_name           = db01                                  # my Hostname
binlog_format             = row
default_storage_engine    = InnoDB
innodb_autoinc_lock_mode  = 2

# Allow the Server to accept Connections on all Interfaces:
# See removed parameter on 50-server.cnf!
bind-address              = 0.0.0.0
```
Please have in mind to do this configuration on ALL nodes that you would start in the cluster.


## Step 5.1 - Start the Cluster-Master
Here we have a difference in starting the first Node and all other Nodes.

To start the first Node and make the cluster master you have to do in a root shell:
```shell
galera_new_cluster
```

After the first Node have been started you could check the State of the cluster master:
```shell
service mariadb status
```


## Step 5.2 - Start the other Cluster-Members
To start all other Members you only have to type:
```shell
service mariadb start
```

When a Cluster has started the first time it is no longer important, that the master node runs in a master mode. 
All new nodes are asking for neighboors on the cluster nodes listed in the 60-Galera.cnf and get unlisted nodes back (if you have more than 3 nodes).
On the master node you could also do a service mariadb restart and it starts as a "Member". 


## Step 6 - Check the replication state of the cluster
To check the State of your cluster fire the Statement in a mysql cli:
```shell
# mysql SHOW GLOBAL STATUS LIKE 'wsrep_%';
```
![wsrep Status Output](images/wsrep_status.png)


## Step 7 - Add nodes to the load balancer
Now add the cloud servers as target to your load balancer. 

![Loadbalancer Targets](images/lb_targets.png)


## Step 8 - Add target services and health monitor to the load balancer
After adding the targets add the service to your load balancer and create the health check.

![Loadbalancer Services](images/lb_service.png)

Edit the parameters for interval, timeout and retries to your needs.
![Loadbalancer Services](images/lb_healthcheck.png)


## Step 9 - Try a Connection to the database
After you have finished the load balancer preparation you could try a connection to the load balancer IP with a MySQL client from a new cloud server that is also added to the private network or with a script file (php, python, ...). 
Your database server ist the IP of the load balancer. 
Choose a user/password that you have granted rights on a database.


## Step 10 - Nice to know and troubleshooting / known problems
- Since mentioned in Step 3 the load balancer health check is marked as unauthenticated connection to the cluster nodes the error counter could be reached. 
  To solve this it´s possible to create a cronjob with the mariadb-admin command to flush the hosts that banned.
  ```shell
  mariadb-admin flush-hosts
  ```

- If you build up one or more new servers and the cluster is up and running, you could put the node IPs from the other 3 Servers in the cnf File for Galera. 
  Over the Cluster-Communication Protocol all Neighboors are broadcasted to the new Machines and all are in replication.

- If you add a new User to MariaDB for Database Access the User is in replication to the other nodes. Also permissions and password is in replication. 
  Other changes in the MySQL database are not in sync! Only users and permissions.

- A backup process could look like this: deploy a new cloud server and add it to the private network, install the MariaDB and Galera binarys as before but don´t add this node to the load balancer and only start a mysqldump in any interval. So your cluster isn´t under load while we do a dump but also get all rows a backed-up database.

## Conclusion

Now we have a working Galera Cluster that allows to take offline one or more nodes the same time and resync after come back. 
All connections to the cluster are routed at the load balancer. 

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Thomas Pieger pieger.tom@gmail.com

-->
