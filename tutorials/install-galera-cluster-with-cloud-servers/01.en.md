---
SPDX-License-Identifier: MIT
path: "/tutorials/install-galera-cluster-with-cloud-servers"
slug: "install-galera-cluster-with-cloud-servers"
date: "2022-09-05"
title: "Build up a MariaDB Galera Cluster in the Hetzner Cloud"
short_description: "I´ll show you how to build up a MariaDB Galera Cluster on Debain 11 inside of the Hetzner Cloud with a LoadBalancer in front of."
tags: ["Galera", "MariaDB", "Cluster", "Cloud", "Debian"]
author: "tompieger"
author_link: "https://github.com/tompieger"
author_img: "https://avatars.githubusercontent.com/u/112869989?s=400&v=4"
author_description: "Full Stack Software Developer"
language: "en"
available_languages: ["en", "de"]
header_img: "header-2"
cta: "cloud"
---

## Introduction

Sometimes it is useful to have a high available MariaDB - with a Galera Cluster. For this Scenario we put the Cluster behind a private Loadbalancer inside the Hetzner Cloud and make the Cluster accessible from other Cloud Servers.

**Prerequisites**

- a LoadBalancer (public IP is disabled)
- min 2 Hetzner Cloud Servers (Debian 11)
- a private Network, attached to the LoadBalancer and the MariaDB Nodes

Terminology that we use in the tutorial:

* Domain: `example.com`
* IP addresses (IPv4) and Hostnames:
   * LoadBalancer: `10.1.0.1`
   * MariaDB Node 1: `<10.1.0.2>` and `db01.example.com`
   * MariaDB Node 2: `<10.1.0.3>` and `db02.example.com`
   * MariaDB Node 3: `<10.1.0.4>` and `db03.example.com`


## Step 1 - Prepare Cloud Servers

After ordering a new Cloud Server (CP11) with Standard-OS Debian 11 login to the Shell as root User and do a first update of the Repo-Lists:
```shell
apt update
apt upgrade
```


## Step2 - Install Software on the DB-Nodes

The MariaDB Projekt makes it easy to add the MariaDB Repo and Dependencys with a small Shell Script.
```shell
curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | sudo bash
```

After the Shell Script has added the MariaDB Repo-Url we could start with the Installation of MariaDB-Server, -Client, Galera4 and some Backup Stuff.
```shell
apt install mariadb-server mariadb-client galera-4 libmariadb3 mariadb-backup -y
```


## Step3 - Configure MariaDB on the Database Nodes
On each Database-Node you have to do the same configuration.

Edit the File `/etc/mysql/mariadb.conf.d/50-server.cnf` and put the parameter or comment it out:
```shell
[server]
# Proxy Protokoll Parameter is needed for Access via the Loadbalancer to the Database Instances:
proxy-protocol-networks=10.1.0.0/24, localhost  # Be aware to set your own private Subnet if other than here!

# While we do a Health Check from the LoadBalancer our Database Nodes are in mind, that this checks are unauthenticated Connections.
# After 2-3 Days the Limit Counter for Error-Connections is raised and the Cluster is working but don´t accept new Connections from our 
# Web-Servers or Application-Servers because of "Black-Listing".
max_connect_errors    = 4294967295
max_connections       = 100000

# ----------------------- 8< --------------------------
## To allow Connections not only on localhost skip off the bind-address parameter.
## For now we accept Connections on the eth0 Address (10.1.0.x)
# bind-address        = 127.0.0.1
# ----------------------- >8 --------------------------
```


## Step4 - Configure Galera on the Database Nodes
The easy Way is to clear the cnf File for the Galera and put only the needed informations inside a empty File:
```shell
echo > /etc/mysql/mariadb.conf.d/60-galera.cnf
```

Now edit the File with nano/vim/....
```shell
nano /etc/mysql/mariadb.conf.d/60-galera.cnf
```

Add the Config and put your own Parameters if needed:
```
# Galera related Settings
# Read more about the Parameters at https://mariadb.com/kb/en/galera-cluster/

[galera]
wsrep_provider            = /usr/lib/galera/libgalera_smm.so
wsrep_on                  = ON                                    # Put the Replication on this Node ON.
wsrep_cluster_name        = "MariaDB Galera Cluster"              # a Name for the Cluster
wsrep_cluster_address     = gcomm://10.1.0.2,10.1.0.3,10.1.0.4    # All IP-Addresses of the Database Nodes including my own Address
wsrep_node_address        = 10.1.0.2                              # my own IP-Address on the private Interface
wsrep_node_name           = db01                                  # my Hostname
binlog_format             = row
default_storage_engine    = InnoDB
innodb_autoinc_lock_mode  = 2

# Allow the Server to accept Connections on all Interfaces:
# See removed Parameter on 50-server.cnf!
bind-address              = 0.0.0.0
```
Please have in mind to do this Configuration on ALL Nodes that you would start in the Cluster.


## Step5 - Start the Cluster-Master
Here we have a difference in starting the first Node and all other Nodes.

To start the first Node and make the Cluster-Master you have to do in a root Shell:
```shell
galera_new_cluster
```

After that the first Node have been started you could check the State of the Cluster Master:
```shell
service mariadb status
```


## Step6 - Start the other Cluster-Members
To start all other Members you only have to type:
```shell
service mariadb start
```

If the Cluster the first Time is started it is no longer important, that the Master-Node runs in Master-Mode. 
On the Master-Node you could also do a service mariadb restart and it starts as a "Member". 


## Step7 - Check the Replication-State of the Cluster
To check the State of your Cluster fire the Statement in a mysql cli:
```shell
# mysql SHOW GLOBAL STATUS LIKE 'wsrep_%';
```



![Screenshot_1](images/Screenshot_2.png)
Steps are the actual steps users will be taking to complete your tutorial.

Each step should build on the previous one, until the final step that finishes the tutorial.

It is important not to skip any steps, no matter how obvious or self-explanatory they may seem.

Feel free to include screenshots, to show exactly what the user should be seeing. Please put screenshots in a separate "images" folder.

The amount of steps will depend entirely on how long/complicated the tutorial is.

## Step 2 - `<Summary of Step>`

Quick introduction.

Start by...

![Screenshot Description](images/screenshot_description.png)

Then...

Finally...

### Step 2.1 - `<Summary of Step>`

Here is a code example

```javascript
var s = "JavaScript syntax highlighting";
alert(s);
```

### Step 2.2 - `<Summary of Step>`

Another code example

```python
s = "Python syntax highlighting"
print s
```

## Step 3 - `<Summary of Step> (Optional)`

Instructions for a step that is not necessary to complete the tutorial, but can be helpful.

## Step N - `<Summary of Step>`

Yet more instructions.

## Conclusion

A short conclusion summarizing what the user has done, and maybe suggesting different courses of action they can now take.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->
