# disable swap, remove its RAID partition, move and extend other RAID partitions

I am using a dedicated root server from hetzner.com which has two 512 GB NVMe SSDs. On each drive are three partitions for swap, /boot und / (everything else). 
These drives are using software RAID 1 with *mdadm* for all three partitions. Thereby I have three partitions:

1. swap or /dev/md0
2. /boot or /dev/md1
3. / or /dev/md2

Since the swap partition is 32 GiB in size and I am running out of storage space, I want to disable swap, remove its partition and add the space to the /dev/md2 partition. 
This tutorial shows how to do exactly that. 

Note: This tutorial was tested on Alma Linux (pretty close to CentOS) but it should work for many other distributions since it mostly uses Linux standard tools.

## gather information about disks and partitions

There are several commands to show information like name, size, UUID, start sector, end sector etc. for each partition and disk. These are:

`fdisk -l`

`blkid`

`lsblk`

`df -h`

These might be helpful to show an intermediate state to visually approve the success of an operation and for debugging purposes.

## disable swap

Swap space is storage space that is used to extend your system memory. In my case I have enough system memory but not enough storage space. 
There are many discussions about the question if swap space is still reasonable with modern SSDs at all. I will not focus on that.

To temporarily disable swap, execute:

`swapoff -a`

You can use *htop* (if installed) to show the swap space size at the top, right below the memory usage.

To permanently disable swap, comment the line in */etc/fstab* that includes "swap" like so:

```
proc /proc proc defaults 0 0
# /dev/md/0
#UUID=38c56f99-6dd4-43e2-801c-c379da1e4ded none swap sw 0 0
# /dev/md/1
UUID=8a084a81-e20b-4239-a8ef-95346788dab6 /boot ext3 defaults 0 0
# /dev/md/2
UUID=85f9f200-0ade-42de-9eac-298005751854 / ext4 defaults 0 0
```

This will prevent the system to mount the swap partition on the following startups. 
You could also remove the line but in general it is a good idea to keep things and just disable them. Think of it as a way back if something breaks.

Now reboot to test if it works and to prepare for the next step.

## remove the swap partition

At first you should disable the RAID array for this partition (if your swap does not use RAID, just skip this):

```
umount /dev/md0
mdadm --stop /dev/md0
mdadm --remove /dev/md0
```

Note: The last command might fail but this is ok. It is just for backwards comaptibility.

Then you should remove the superblocks on the partitions of each disk (this is still for RAID). To list the disk partitions of the RAID partition, list all arrays like so:

`cat /proc/mdstat`

My disk partitions of /dev/md0 are /dev/nvme0n1p1 and /dev/nvme1n1p1.

Then execute the following for all disk partitions (space separated):

`mdadm --zero-superblock /dev/nvme0n1p1 /dev/nvme1n1p1`

Then remove the disk partition(s) with *fdisk* and the disk name using

`fdisk /dev/nvme0n1`

Note: this is not the partition name but the disk name of the before used partitions.

Then enter `d` to delete a partition. It will ask for the partition number which is 1 in my case. Enter it and your partition will be deleted. 
Repeat this step for every disk if you are using RAID.

Note: I am not sure why but I had to comment the line regarding /dev/md0 in /etc/mdadm.conf to really disable RAID for this partition. 

## move the other RAID partitions

Now we will treat the tricky part. You should (or even must) use a separate operating system which does not use the partitions you want to move. 
I used the rescue system which is booted via network and can be configured using the hetzner.com administration page of the server. 
If you are using another provider search for something like that, every provider I used so far has such a tool.

To move a partition to the left (meaning to the beginning of the disk) type:

`echo '-32G,' | sfdisk --move-data /dev/nvme0n1 -N 2`

where 32G means move the partition 32 GiB to the left (minus is left, plus would be right). The `-N 2` stands for partition number 2. 

You need to repeat this for every partition you want to move and for every device in your raid array.

## resize RAID partition

To resize the RAID partition you need to do the following three steps. A reboot after each step is recommended or even mandatory.

### 1. resize the disk partitions

Use *parted* for resizing (just enter `parted`, it will start the interactive tool). There you need to select the correct disk using e.g. `select /dev/nvme0n1`. 
Then you can show all the partitions and free spaces on the disk with `print free`. `resizepart` will ask for the partition number and the desired size of the partition.
Again repeat this for every disk in your RAID array.

### 2. resize the RAID partition

This is not an alternative step for step 1, it is additional! 

You now need to tell *mdadm* to use more space of the disk partitions for its RAID partition. I my case I want to resize /dev/md2 to 485210 MiB.

`mdadm --grow --size=485210M /dev/md2`

### 3. expand the filesystem

As you might have seen, `df -h` still shows the old size. To fix that we have to do one last step:
Finally use `resize2fs -p /dev/md2` to enlarge the filesystem to the new size of /dev/md2.