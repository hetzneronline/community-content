---
SPDX-License-Identifier: MIT
path: "/tutorials/create-a-client-server-for-your-private-network-using-cloud-config"
slug: "create-a-client-server-for-your-private-network-using-cloud-config"
date: "2023-03-12"
title: "Create a client server for your private network using cloud-config! :+1:"
short_description: "With this tutorial you will be able to create a new client-server for your private network without configuration or a public interface."
tags: ["Cloud", "Linux"]
author: "riwin"
author_link: "https://github.com/riwin"
author_img: "https://avatars.githubusercontent.com/u/22272560?v=4"
author_description: ""
language: "en"
available_languages: ["en"]
header_img: "header-x"
cta: "product"
---

## Introduction

Using this tutorial you will be able to add a new server to your private cloud network. You dont need a public interface (no public IP address) or configure any static routes to your self hosted gateway. If your gateway has a DNS-Server it will be used by your new server.

**Prerequisites**

In order to use this tutorial you need a self-hosted Gateway in your private network. There is another [Tutorial](https://community.hetzner.com/tutorials/how-to-route-cloudserver-over-private-network-using-pfsense-and-hcnetworks) available that covers the setup of a pfSense-Server as a gateway/firewall.

This tutorial is using the "Ubuntu 22.04"-image provided by Hetzner for the client-servers.


We are using 10.0.0.0/24 as our private network and 10.0.0.2 as our pfSense-Server.

## Step 1 - `Prepare netplan configuration`
We want cloud-config to create a file (/etc/netplan/51-netcfg.yaml) to set a default route.

```yaml
network:
  version: 2
  ethernets:
    ens10:
      dhcp4: true
      routes:
      - to 0.0.0.0/0
        via: 10.0.0.1
```
ens10 is the interface-name of our private network.
We need to send all outgoing traffic to the hetzner gateway.
The hetzner gateway is already configured to send all traffic to the pfSense-server in the linked tutorial.


## Step 2 - `Prepare resolved configuration` (optional)

If you want to keep the default nameservers applied by hetzner, this step is optional and can be skipped.

If you want to use your pfSense as DNS-server or if you want to configure other DNS-servers, we need to change the resolved.conf

```conf
[Resolve]
DNS=10.100.0.2
```

## Step 3 - `Build the Cloud-Config Script`

Now we need to setup cloud-config to apply our prepared configuration files. The Cloud-Config script will reboot the server when our two files are written.

```yaml
#cloud-config
write_files:
  - path: /etc/netplan/51-netcfg.yaml
    permissions: '0644'
    content: |
      network:
        version: 2
        ethernets:
          ens10:
            dhcp4: true
            routes:
            - to: 0.0.0.0/0
              via: 10.0.0.1
  - path: /etc/systemd/resolved.conf
    content: |
      [Resolve]
      DNS=10.0.0.2
runcmd:
  - reboot
```

## Step 4 - `Create a new Server`

Navigate to the Hetzner-Cloud and create a new Ubuntu 22.04 server only using your private network. We don't need any public interfaces. 

Use the cloud-config script from step 3 and make needed changes to fit your environment and paste it into the "Cloud config" Configuration Field at the bottom of the wizzard. Create your server and give it some time to reboot.

## Step 5 - `Verify your Configuration`

If you have a VPN connection to your pfSense, you should be able to ssh into the created Server.

If not you need to use the console access in the hetzner cloud ui.

### Verify DNS-Server

```bash
resolvectl status
```

You should see your configured DNS-Server

### Verify Default-Route

```bash
ip route
```
You should see a default route:

```
default via 10.0.0.1 dev ens10 proto static onlink
```


##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->
