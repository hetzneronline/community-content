---
SPDX-License-Identifier: MIT
path: "/tutorials/testing-ansible-with-molecule"
slug: "testing-ansible-with-molecule"
date: "2023-12-28"
title: "Unit Test Ansible with Molecule"
short_description: "In this tutorial, we will unit test ansible role with molecule framework"
tags: ["ansible", "molecule", "testing", "roles"]
author: "Harshavardhan Musanalli"
author_link: "https://github.com/harshavmb"
author_img: "https://avatars.githubusercontent.com/u/10049720"
author_description: ""
language: "en"
available_languages: ["en", "de"]
header_img: "header-3"
cta: "cloud"
---

## Introduction
Ansible Molecule is a powerful testing framework that simplifies the process of testing Ansible roles in different scenarios. In this tutorial, we will guide you through the process of setting up and using Ansible Molecule to test your Ansible roles effectively.

## Why use molecule to test ansible?
Below are the reasons why you should consider using molecule:
* **Automated Testing**: Molecule automates the testing process for Ansible roles, allowing you to define and execute test scenarios easily. This automation helps catch issues early in the development cycle, ensuring that roles behave as expected.
* **Isolation of Environments**: Molecule uses different drivers (e.g., Docker, Vagrant) to create isolated environments for testing. This ensures that tests are consistent and reproducible across different systems, reducing the likelihood of environment-related issues.
* **Multiple Testing Scenarios**: Molecule supports the definition of multiple scenarios, allowing you to test roles under various conditions. For example, you can test different operating systems, Ansible versions, or configurations to ensure role compatibility.
* **Continuous Integration (CI)**: Molecule is designed to work seamlessly with CI systems like Travis CI, Jenkins, or GitLab CI. This enables you to automate the testing process every time changes are pushed to your version control system, ensuring continuous quality assurance.
* **Role Development Support**: Molecule includes tools for role development, such as role initialization, linting, and dependency management. This streamlines the development workflow and helps maintain a consistent codebase.
* **Parallel Execution**: Molecule supports parallel execution of tests, allowing you to save time when testing multiple scenarios simultaneously. This is crucial for speeding up the feedback loop during development.
* **Documentation and Best Practices**: Molecule encourages best practices in role development and testing. The tool's documentation provides clear guidance on structuring roles, writing effective test cases, and following recommended conventions.
* **Community Adoption**: Molecule is widely adopted within the Ansible community. Many Ansible roles and projects use Molecule for testing, making it a well-supported and reliable choice for role developers.

## Prerequisites
Before we dive into the demo, make sure you have the following prerequisites in place. For CI workloads, `docker` is highly recommended without the need of `virtualenv`.
* **python**: Ansible is built on top of Python. Hence, it is the first first prerequisite. One could install python either with OS package manager or by compiling from sources. python3 is highly recommended.
* **pip**: Pip is the package manager of Python. We install molecule with pip as it is not yet available as an OS rpm.
* **ansible**: We need ansible to be installed. Just like python this could be installed either with OS package manager or from pip. 
* **molecule**: Install molecule with pip. It is as simple as running `pip3 install --no-cache-dir -r molecule[ansible]` command.
* **hetzner.hcloud collections(Optional)** :  This depends on your usecase. For the sake of this demo, we will be testing the ansible role on `hetzner` infrastructure by provisioning a VM, connecting over `SSH` & executing the role on the target VM. We install the collections by running `ansible-galaxy collection install hetzner.hcloud` command. 

## Use case (an example)
In this demo we will apply our OS hardening ansible role on our VM infrastructure. Let's assume our VM infrastructure has a mix of different OS distributions, major/minor versions. A tiny change made to the hardening role needs to be tested thoroughly on each OS flavor as part of Continuous Integration (CI).

### Step 1 - Adding molecule testing to an existing role
Usual ansible role directory structure would be something like below:
```bash
harsha@dev os_hardening_role % ls -lart
total 56
-rw-r--r--   1 harsha  staff    65 21 Nov 12:24 .gitignore
-rw-r--r--   1 harsha  staff     0 21 Nov 12:24 README
drwxr-xr-x   3 harsha  staff    96 21 Nov 12:24 defaults
-rw-r--r--   1 harsha  staff    94 21 Nov 12:24 os_hardening.yml
drwxr-xr-x   3 harsha  staff    96 21 Nov 12:24 files
drwxr-xr-x   3 harsha  staff    96 21 Nov 12:24 meta
drwxr-xr-x   3 harsha  staff    96 21 Nov 12:24 tasks
drwxr-xr-x   3 harsha  staff    96 21 Nov 12:24 vars
drwxr-xr-x  17 harsha  staff   544 21 Nov 12:25 .
drwxr-xr-x   3 harsha  staff    96 21 Nov 15:57 molecule
drwxr-xr-x  13 harsha  staff   416 22 Nov 17:02 .git
drwxr-xr-x  52 harsha  staff  1664 19 Dec 16:21 ..
```

### Step 3 - Adding Molecule to the Collection
Inside the role directory, run `molecule init scenario` command. Upon execution, one will see few directories & files getting created. It would be something like below:
```bash
harsha@dev os_hardening_role % ls -lart molecule/default 
total 48
-rw-r--r--  1 harsha  staff   176 21 Nov 15:04 verify.yml
drwxr-xr-x  3 harsha  staff    96 21 Nov 15:57 ..
-rw-r--r--  1 harsha  staff   169 22 Nov 15:12 converge.yml
drwxr-xr-x  8 harsha  staff   256 22 Nov 15:56 .
-rw-r--r--  1 harsha  staff  1345 22 Nov 16:53 create.yml
-rw-r--r--  1 harsha  staff  2114 22 Nov 16:54 molecule.yml
-rw-r--r--  1 harsha  staff   839 23 Nov 16:45 destroy.yml
```

### Step 3 - Role Scenarios
Scenarios are the starting point for a lot of powerful functionality that Molecule offers. For now, we can think of a scenario as a test suite for roles or playbooks within a collection. One can have as many scenarios as they like and Molecule will run one after the other.

### Step 4 - The Scenario Layout
* `create.yml`  is a playbook file used for creating the instances and storing data in instance-config. An example of a Ubuntu 22.04 Hetzner server with ssh key is below.

```bash
## could also be iterated over `loop` or `with_items` from the defined vars in `molecule.yml`
- name: Create a test Ubuntu 22.04 with ssh key
  hosts: localhost
  connection: local
  hetzner.hcloud.server:
    name: molecule2204
    server_type: cx11
    image: ubuntu-22.04
    location: fsn1
    ssh_keys:
      - me@myorganisation
    state: present
    register: vm_output

## this is required for converge.yml
- name: Generate ssh_config
  template:
    src: ssh_config.j2
    dest: /tmp/ssh_config
  vars: 
    hosts: "{{ vm_output.results }}"    
```

* `destroy.yml` has the Ansible code for destroying the instances and removing them from instance-config. It's more or less same as `create` expect that `state` has to be marked `absent`. Below is an example:
```bash
- name: Destroy the test Ubuntu 22.04
  hosts: all
  connection: local
  hetzner.hcloud.server:
    name: molecule2204
    state: absent
```

* `molecule.yml` is the central configuration entry point for Molecule per scenario. With this file, one can configure each tool that Molecule will employ when testing your role.
```bash
---
# The dependency manager. Molecule uses galaxy development guide by default to resolve your role dependencies.
dependency:
  name: galaxy
# The driver provider. Molecule uses the Delegated driver by default. Molecule uses the driver to delegate the task of creating instances.  
driver:
  name: default
# The platforms definitions. Molecule relies on this to know which instances to create, name and to which group each instance belongs. If you need to test your role against multiple Ubuntu flavours (18.04, 20.04, 22.04), you can specify that in this section.    
platforms:
  - name: molecule-test-vm-ubuntu18
    image: "ubuntu-18.04"
  - name: molecule-test-vm-ubuntu20  
    image: "ubuntu-20.04"  
  - name: molecule-test-vm-ubuntu22
    image: "ubuntu-22.04"
# The provisioner. Molecule only provides an Ansible provisioner. Ansible manages the life cycle of the instance based on this configuration.    
provisioner:
  name: ansible
  inventory:
    ## these vars can be used in create.yml/destroy.yml/converge.yml/verify.yml playbooks replacing hardcoded strings
    ## to test against multiple images simply use `loop` or `with_items`
    group_vars:
      all:        
        admin_user: "azureuser"
        admin_ssh_public_key: "ssh-rsa/ed25519 ..public-key"
        server_type: "cx11"
        location: "fsn1"
  ## this we use to ssh to target Hetzner test VM      
  connection_options:
    ansible_ssh_common_args: " -o ControlMaster=auto -o ControlPersist=60s -o PreferredAuthentications=publickey,password -F /tmp/ssh_config -o StrictHostKeychecking=no"
# The verifier framework. Molecule uses Ansible by default to provide a way to write specific state checking tests (such as deployment smoke tests) on the target instance.    
verifier:
  name: ansible
# The scenario definition. Molecule relies on this configuration to control the scenario sequence order.  
scenario:
  name: default
  ## below test sequence starts with `destroy` to ensure we have clean infrastructure state.
  test_sequence:
    - destroy
    - create
    - converge  
    - verify
    - destroy
    - destroy
# we can disable the lint if you want but highly recommended to have it enabled as yaml linting is very essential to improve code quality checks
#lint: |
#  ansible-lint --exclude molecule/default/
```

* `converge.yml` is the playbook file that contains the call for your role. Molecule will invoke this playbook with ansible-playbook and run it against an instance created by the driver. In our case it's `os_hardening_role`.
```bash
---
- name: Converge
  hosts: all
  become: yes
  gather_facts: true
  tasks:
    - name: "Include os_hardening_role"
      include_role:
        name: "os_hardening_role"
```

* `verify.yml` is the playbook that validates our roles. As said earlier it's more or less equivalent to `assert`. You could add more checks here. For the sake of this demo, we ensure `root` login is disabled as part of hardening.
```bash
---
- name: Verify OS Hardening Control
  hosts: all
  become: yes

  tasks:
    - name: Ensure root login is disabled
      command: grep '^PermitRootLogin' /etc/ssh/sshd_config
      register: root_login_config
      failed_when: "'yes' in root_login_config.stdout"
```

### Step 5 - Build ssh configuration
Ansible primarily relies on `ssh` to connect to target machine to execute tasks. As we are provisioning crash & burn VMs for our testing, we create ssh configuration for each VM to build the inventory and that's passed as `ansible_ssh_common_args` to `ansible` by `molecule`. A simple jinja2 template would be like below:
```bash
harsha@dev os_hardening_role % cat molecule/default/ssh_config.j2 
{% for host in hosts %}
Host {{ host.ansible_facts.hcloud_server.name }}
    HostName {{ host.ansible_facts.hcloud_server.private_networks_info[0].ip }}
    User hetzner
    IdentityFile /tmp/fop-mgt-key.pem
{% endfor %}%
```

## Execute molecule
Molecule provides commands for manually managing the lifecycle of the instance, scenario, development and testing tools. However, we can also tell Molecule to manage this automatically within a scenario sequence. 
```bash
Molecule full lifecycle sequence
└── default
    ├── dependency
    ├── cleanup
    ├── destroy
    ├── syntax
    ├── create
    ├── prepare
    ├── converge
    ├── idempotence
    ├── side_effect
    ├── verify
    ├── cleanup
    └── destroy
```

The full lifecycle sequence can be invoked with `molecule test` command. An example run :
```bash
harsha@dev os_hardening_role % molecule test
[WARNING]: log file at /var/log/ansible.log is not writeable and we cannot create it, aborting

[WARNING]: log file at /var/log/ansible.log is not writeable and we cannot create it, aborting

INFO     default scenario test matrix: destroy, create, converge, verify, destroy, destroy
INFO     Performing prerun with role_name_check=0...
INFO     Using /Users/harsha/.ansible/roles/amadeus.os_hardening_role symlink to current repository in order to enable Ansible to find the role using its expected full name.
INFO     Running default > destroy

PLAY [Destroy] *****************************************************************

TASK [Cleanup inventory file] **************************************************
ok: [molecule-test-vm-ubuntu18]
ok: [molecule-test-vm-ubuntu20]
ok: [molecule-test-vm-ubuntu22]

TASK [Remove VMs from Hetzner] ***************************************************
ok: [molecule-test-vm-ubuntu18] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
ok: [molecule-test-vm-ubuntu20] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
ok: [molecule-test-vm-ubuntu22] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > create

PLAY [Create] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Create VM with defaults on Azure] ****************************************
changed: [localhost] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
changed: [localhost] => (item={'image': 'ubuntu-20.04', 'name': 'molecule-test-vm-ubuntu20'})
changed: [localhost] => (item={'image': 'ubuntu-22.04', 'name': 'molecule-test-vm-ubuntu22'})

TASK [Generate ssh_config] *****************************************************
changed: [localhost]

TASK [Pause for 1 minute to ssh process to come up] ****************************
Pausing for 60 seconds
(ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > converge

PLAY [Converge] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [molecule-test-vm-ubuntu18]
ok: [molecule-test-vm-ubuntu22]
ok: [molecule-test-vm-ubuntu20]

TASK [Include os_hardening_role] ************************************************

TASK [os_hardening_role : Ensure root login is disabled] ***
changed: [molecule-test-vm-ubuntu18]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu20]

TASK [os_hardening_role : Ensure password authentication is disabled] ****************
changed: [molecule-test-vm-ubuntu18]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu20]

TASK [os_hardening_role : Ensure SELinux is enforcing] *********************
changed: [molecule-test-vm-ubuntu18]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu20]

... trimmed for brevity...

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=8    changed=4    unreachable=0    failed=0    skipped=6    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=8    changed=4    unreachable=0    failed=0    skipped=6    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=8    changed=4    unreachable=0    failed=0    skipped=6    rescued=0    ignored=0

INFO     Running default > verify
INFO     Running Ansible Verifier

PLAY [Verify] ******************************************************************

TASK [Example assertion] *******************************************************
ok: [molecule-test-vm-ubuntu18] => {
    "changed": false,
    "msg": "All assertions passed"
}
ok: [molecule-test-vm-ubuntu20] => {
    "changed": false,
    "msg": "All assertions passed"
}
ok: [molecule-test-vm-ubuntu22] => {
    "changed": false,
    "msg": "All assertions passed"
}

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Verifier completed successfully.
INFO     Running default > destroy

PLAY [Destroy] *****************************************************************

TASK [Cleanup inventory file] **************************************************
changed: [molecule-test-vm-ubuntu20]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu18]

TASK [Remove VMs from Azure] ***************************************************
ok: [molecule-test-vm-ubuntu22] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
ok: [molecule-test-vm-ubuntu20] => (item={'image': 'ubuntu-20.04', 'name': 'molecule-test-vm-ubuntu20'})
ok: [molecule-test-vm-ubuntu20] => (item={'image': 'ubuntu-22.04', 'name': 'molecule-test-vm-ubuntu22'})

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Pruning extra files from scenario ephemeral directory
```

## Additional lifecycle scenarios
In above demo, we do see `idempotence` which in somecases is quite important & you could plugin such scenario in `molecule.yml`. This way we tell ansible to execute the ansible once again to ensure our role meets the `idempotence` criteria. For more scenario related details you could visit [molecule-scenarios](https://ansible.readthedocs.io/projects/molecule/configuration/#scenario). 

## Conclusion
Congratulations! You've successfully set up and tested an Ansible role using Molecule. We covered the basics & testing scenarios on various Ubuntu flavours. Explore further and apply Molecule to your Ansible projects for robust and reliable roles.

Additional Resources
* [Molecule Documentation](https://ansible.readthedocs.io/projects/molecule/)
* [Ansible Galaxy](https://ansible.readthedocs.io/projects/galaxy-ng/en/latest/community/userguide/)
* [Hetzner ansible module](https://docs.ansible.com/ansible/latest/collections/hetzner/hcloud/server_module.html)

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Harshavardhan Musanalli<harshavmb@gmail.com>

-->