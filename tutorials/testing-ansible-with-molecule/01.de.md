---
SPDX-License-Identifier: MIT
path: "/tutorials/testing-ansible-with-molecule"
slug: "testing-ansible-with-molecule"
date: "2023-12-28"
title: "Unit Test ansible mit molecule"
short_description: "In diesem Tutorial werden wir Ansible roles mit dem Molecule-Framework testen"
tags: ["ansible", "molecule", "testing", "roles"]
author: "Harshavardhan Musanalli"
author_link: "https://github.com/harshavmb"
author_img: "https://avatars.githubusercontent.com/u/10049720"
author_description: ""
language: "de"
available_languages: ["en", "de"]
header_img: "header-3"
cta: "cloud"
---

## Einführung
Ansible Molecule ist ein leistungsstarkes Test-Framework, das den Prozess des Testens von Ansible roles in verschiedenen Szenarien vereinfacht. In diesem Tutorial führen wir Sie durch den Prozess der Einrichtung und Verwendung von Ansible Molecule, um Ihre Ansible roles effektiv zu testen.

## Warum Molecule zum Testen von Ansible verwenden?
Im Folgenden sind die Gründe aufgeführt, warum Sie Molecule verwenden sollten:
* **Automatisiertes Testen**: Molecule automatisiert den Testprozess für Ansible-Rollen und ermöglicht Ihnen die einfache Definition und Ausführung von Testszenarien. Diese Automatisierung hilft, Probleme frühzeitig im Entwicklungszyklus zu erkennen und stellt sicher, dass sich die Rollen wie erwartet verhalten.
**Isolierung von Umgebungen**: Molecule verwendet verschiedene Treiber (z. B. Docker, Vagrant), um isolierte Umgebungen für Tests zu schaffen. Dadurch wird sichergestellt, dass die Tests über verschiedene Systeme hinweg konsistent und reproduzierbar sind, was die Wahrscheinlichkeit von umgebungsbezogenen Problemen verringert.
**Mehrere Test-Szenarien**: Molecule unterstützt die Definition mehrerer Szenarien, die es Ihnen ermöglichen, Rollen unter verschiedenen Bedingungen zu testen. So können Sie beispielsweise verschiedene Betriebssysteme, Ansible-Versionen oder Konfigurationen testen, um die Kompatibilität der Rollen sicherzustellen.
* **Continuous Integration (CI)**: Molecule ist so konzipiert, dass es nahtlos mit CI-Systemen wie Travis CI, Jenkins oder GitLab CI zusammenarbeitet. Dadurch können Sie den Testprozess jedes Mal automatisieren, wenn Änderungen in Ihr Versionskontrollsystem übertragen werden, und so eine kontinuierliche Qualitätssicherung gewährleisten.
**Unterstützung der Rollenentwicklung**: Molecule enthält Tools für die Rollenentwicklung, wie z. B. Rolleninitialisierung, Linting und Abhängigkeitsmanagement. Dies rationalisiert den Entwicklungsworkflow und trägt zur Erhaltung einer konsistenten Codebasis bei.
**Parallele Ausführung**: Molecule unterstützt die parallele Ausführung von Tests, so dass Sie Zeit sparen können, wenn Sie mehrere Szenarien gleichzeitig testen. Dies ist entscheidend für die Beschleunigung der Feedbackschleife während der Entwicklung.
**Dokumentation und Best Practices**: Molecule fördert bewährte Praktiken bei der Rollenentwicklung und beim Testen. Die Dokumentation des Tools bietet klare Anleitungen zur Strukturierung von Rollen, zum Schreiben effektiver Testfälle und zur Einhaltung empfohlener Konventionen.
* **Gemeinschaftliche Akzeptanz**: Molecule ist in der Ansible-Community weit verbreitet. Viele Ansible-Rollen und -Projekte verwenden Molecule zum Testen, was es zu einer gut unterstützten und zuverlässigen Wahl für Rollenentwickler macht.

## Voraussetzungen
Bevor wir uns in die Demonstration stürzen, stellen Sie sicher, dass die folgenden Voraussetzungen erfüllt sind. Für CI-Workloads wird `docker` ohne die Notwendigkeit von `virtualenv` dringend empfohlen.
* **python**: Ansible basiert auf Python. Daher ist es die erste Voraussetzung. Python kann entweder mit dem Paketmanager des Betriebssystems oder durch Kompilieren aus den Quellen installiert werden. Python 3 wird dringend empfohlen.
* **pip**: Pip ist der Packagemanager von Python. Wir installieren Molecule mit pip, da es noch nicht als OS-RPM verfügbar ist.
* **ansible**: Ansible muss installiert sein. Wie Python kann auch dies entweder mit dem Paketmanager des Betriebssystems oder mit pip installiert werden.
* **molecule**: Installieren Sie Molecule mit pip. Es ist so einfach wie das Ausführen des Befehls `pip3 install --no-cache-dir -r molecule[ansible]`.
* **hetzner.hcloud collections(Optional)** :  Dies hängt von Ihrem Anwendungsfall ab. Für diese Demo testen wir die Ansible-Rolle auf der `hetzner`-Infrastruktur, indem wir eine VM bereitstellen, uns über `SSH` verbinden und die Rolle auf der Ziel-VM ausführen. Die Sammlungen installieren wir mit dem Befehl `ansible-galaxy collection install hetzner.hcloud`. 

## Anwendungsfall (Ein Beispiel)
In diesem Demo werden wir unsere OS-Härtungsrolle auf unserer VM-Infrastruktur anwenden. Nehmen wir an, unsere VM-Infrastruktur umfasst eine Mischung verschiedener Betriebssystemverteilungen, Haupt- und Nebenversionen. Eine kleine Änderung an der Härtungsrolle muss als Teil der kontinuierlichen Integration (CI) gründlich auf jeder OS-Variante getestet werden.

### Step 4 - Das Scenario-Layout
* `create.yml`  ist eine Playbook-Datei, die für das Erstellen der Instanzen und das Speichern von Daten in der Instanz-Konfiguration verwendet wird. Ein Beispiel für einen Ubuntu 22.04 Hetzner-Server mit SSH-Key ist unten aufgeführt.

```bash
## könnte auch über `loop` oder `with_items` von den in `molecule.yml` definierten Variablen iteriert werden
- name: Create a test Ubuntu 22.04 with ssh key
  hosts: localhost
  connection: local
  hetzner.hcloud.server:
    name: molecule2204
    server_type: cx11
    image: ubuntu-22.04
    location: fsn1
    ssh_keys:
      - me@myorganisation
    state: present
    register: vm_output

## dies ist für `converge.yml` erforderlich
- name: Generate ssh_config
  template:
    src: ssh_config.j2
    dest: /tmp/ssh_config
  vars: 
    hosts: "{{ vm_output.results }}"    
```

* `destroy.yml` hat den Ansible-Code zum Zerstören der Instanzen und zum Entfernen aus der instance-config. Es ist mehr oder weniger dasselbe wie `create`, nur dass der `state` als `absent` markiert werden muss. Hier ist ein Beispiel:
```bash
- name: Destroy the test Ubuntu 22.04
  hosts: all
  connection: local
  hetzner.hcloud.server:
    name: molecule2204
    state: absent
```

* `molecule.yml` ist der zentrale Konfigurations-Einstiegspunkt für Molecule pro Szenario. Mit dieser Datei kann man jedes Tool konfigurieren, das Molecule verwenden wird, um die Rolle zu testen.
```bash
---
# The dependency manager. Molecule verwendet standardmäßig die Galaxy Development Guide, um die Abhängigkeiten Ihrer Rolle aufzulösen.
dependency:
  name: galaxy
# The driver provider. Molecule verwendet standardmäßig den Delegated-Treiber. Molecule verwendet den Treiber, um die Aufgabe der Erstellung von Instanzen zu delegieren.  
driver:
  name: default
# The platforms definitions. Molecule verlässt sich darauf, um zu wissen, welche Instanzen erstellt werden sollen, wie sie benannt werden sollen und zu welcher Gruppe jede Instanz gehört. Wenn Sie Ihre Rolle gegen verschiedene Ubuntu-Versionen testen müssen (18.04, 20.04, 22.04), können Sie dies in diesem Abschnitt angeben.  
platforms:
  - name: molecule-test-vm-ubuntu18
    image: "ubuntu-18.04"
  - name: molecule-test-vm-ubuntu20  
    image: "ubuntu-20.04"  
  - name: molecule-test-vm-ubuntu22
    image: "ubuntu-22.04"
# The provisioner. Molecule bietet nur einen Ansible-Provisioner. Ansible verwaltet den Lebenszyklus der Instanz basierend auf dieser Konfiguration.   
provisioner:
  name: ansible
  inventory:
    ## Diese Variablen können in den Playbooks create.yml/destroy.yml/converge.yml/verify.yml verwendet werden, um fest codierte Zeichenfolgen zu ersetzen. Um gegen mehrere Images zu testen, verwenden Sie einfach `loop` oder `with_items`.
    group_vars:
      all:        
        admin_user: "azureuser"
        admin_ssh_public_key: "ssh-rsa/ed25519 ..public-key"
        server_type: "cx11"
        location: "fsn1"
  ## Dies wird verwendet, um eine SSH-Verbindung zur Ziel-Hetzner-Test-VM herzustellen.
  connection_options:
    ansible_ssh_common_args: " -o ControlMaster=auto -o ControlPersist=60s -o PreferredAuthentications=publickey,password -F /tmp/ssh_config -o StrictHostKeychecking=no"
# Das Verifizierer-Framework. Molecule verwendet standardmäßig Ansible, um eine Möglichkeit bereitzustellen, spezifische Statusprüfungstests (wie Deployment-Smoke-Tests) auf der Zielinstanz zu schreiben.    
verifier:
  name: ansible
# The scenario definition. Molecule verlässt sich auf diese Konfiguration, um die Reihenfolge der Szenario-Sequenz zu steuern.
scenario:
  name: default
  ## Die Testsequenz beginnt mit `destroy`, um sicherzustellen, dass wir einen sauberen Infrastrukturzustand haben.
  test_sequence:
    - destroy
    - create
    - converge  
    - verify
    - destroy
    - destroy
# Wir können die Überprüfung (Linting) deaktivieren, wenn Sie möchten, aber es wird dringend empfohlen, sie aktiviert zu lassen, da das Linting von YAML sehr wichtig ist, um die Qualität der Codeüberprüfungen zu verbessern.
#lint: |
#  ansible-lint --exclude molecule/default/
```

* `converge.yml` ist die Playbook-Datei, die den Aufruf Ihrer Rolle enthält. Molecule wird dieses Playbook mit `ansible-playbook` aufrufen und es gegen eine Instanz ausführen, die vom Treiber erstellt wurde. In unserem Fall ist es `os_hardening_role`.
```bash
---
- name: Converge
  hosts: all
  become: yes
  gather_facts: true
  tasks:
    - name: "Include os_hardening_role"
      include_role:
        name: "os_hardening_role"
```

* Das `verify.yml`-Playbook validiert unsere Rollen. Wie zuvor erwähnt, entspricht es mehr oder weniger einem `assert`. Sie können hier weitere Überprüfungen hinzufügen. In diesem Beispiel stellen wir sicher, dass die Anmeldung als `root` als Teil der Härtung deaktiviert ist.
```bash
---
- name: Verify OS Hardening Control
  hosts: all
  become: yes

  tasks:
    - name: Ensure root login is disabled
      command: grep '^PermitRootLogin' /etc/ssh/sshd_config
      register: root_login_config
      failed_when: "'yes' in root_login_config.stdout"
```

### Step 5 - Erstellen Sie die SSH-Konfiguration
Ansible verlässt sich hauptsächlich auf `ssh`, um eine Verbindung zur Zielmaschine herzustellen und Aufgaben auszuführen. Da wir Crash-&-Burn-VMs für unsere Tests bereitstellen, erstellen wir für jede VM eine SSH-Konfiguration, um das Inventar aufzubauen. Diese Konfiguration wird als `ansible_ssh_common_args` von `molecule` an `ansible` übergeben. Eine einfache Jinja2-Vorlage könnte wie folgt aussehen:
```bash
harsha@dev os_hardening_role % cat molecule/default/ssh_config.j2 
{% for host in hosts %}
Host {{ host.ansible_facts.hcloud_server.name }}
    HostName {{ host.ansible_facts.hcloud_server.private_networks_info[0].ip }}
    User hetzner
    IdentityFile /tmp/fop-mgt-key.pem
{% endfor %}%
```

## Execute molecule
Molecule bietet Befehle zum manuellen Verwalten des Lebenszyklus der Instanz, des Szenarios, der Entwicklungs- und Testwerkzeuge. Wir können Molecule jedoch auch mitteilen, dies automatisch innerhalb einer Szenariosequenz zu verwalten. 
```bash
Vollständiger Lebenszyklusablauf von Molecule
└── default
    ├── dependency
    ├── cleanup
    ├── destroy
    ├── syntax
    ├── create
    ├── prepare
    ├── converge
    ├── idempotence
    ├── side_effect
    ├── verify
    ├── cleanup
    └── destroy
```

Der vollständige Lebenszyklus kann mit dem Befehl `molecule test` aufgerufen werden. Ein Beispiel für die Ausführung:
```bash
harsha@dev os_hardening_role % molecule test
[WARNING]: log file at /var/log/ansible.log is not writeable and we cannot create it, aborting

[WARNING]: log file at /var/log/ansible.log is not writeable and we cannot create it, aborting

INFO     default scenario test matrix: destroy, create, converge, verify, destroy, destroy
INFO     Performing prerun with role_name_check=0...
INFO     Using /Users/harsha/.ansible/roles/amadeus.os_hardening_role symlink to current repository in order to enable Ansible to find the role using its expected full name.
INFO     Running default > destroy

PLAY [Destroy] *****************************************************************

TASK [Cleanup inventory file] **************************************************
ok: [molecule-test-vm-ubuntu18]
ok: [molecule-test-vm-ubuntu20]
ok: [molecule-test-vm-ubuntu22]

TASK [Remove VMs from Hetzner] ***************************************************
ok: [molecule-test-vm-ubuntu18] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
ok: [molecule-test-vm-ubuntu20] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
ok: [molecule-test-vm-ubuntu22] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > create

PLAY [Create] ******************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Create VM with defaults on Azure] ****************************************
changed: [localhost] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
changed: [localhost] => (item={'image': 'ubuntu-20.04', 'name': 'molecule-test-vm-ubuntu20'})
changed: [localhost] => (item={'image': 'ubuntu-22.04', 'name': 'molecule-test-vm-ubuntu22'})

TASK [Generate ssh_config] *****************************************************
changed: [localhost]

TASK [Pause for 1 minute to ssh process to come up] ****************************
Pausing for 60 seconds
(ctrl+C then 'C' = continue early, ctrl+C then 'A' = abort)
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Running default > converge

PLAY [Converge] ****************************************************************

TASK [Gathering Facts] *********************************************************
ok: [molecule-test-vm-ubuntu18]
ok: [molecule-test-vm-ubuntu22]
ok: [molecule-test-vm-ubuntu20]

TASK [Include os_hardening_role] ************************************************

TASK [os_hardening_role : Ensure root login is disabled] ***
changed: [molecule-test-vm-ubuntu18]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu20]

TASK [os_hardening_role : Ensure password authentication is disabled] ****************
changed: [molecule-test-vm-ubuntu18]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu20]

TASK [os_hardening_role : Ensure SELinux is enforcing] *********************
changed: [molecule-test-vm-ubuntu18]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu20]

... trimmed for brevity...

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=8    changed=4    unreachable=0    failed=0    skipped=6    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=8    changed=4    unreachable=0    failed=0    skipped=6    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=8    changed=4    unreachable=0    failed=0    skipped=6    rescued=0    ignored=0

INFO     Running default > verify
INFO     Running Ansible Verifier

PLAY [Verify] ******************************************************************

TASK [Example assertion] *******************************************************
ok: [molecule-test-vm-ubuntu18] => {
    "changed": false,
    "msg": "All assertions passed"
}
ok: [molecule-test-vm-ubuntu20] => {
    "changed": false,
    "msg": "All assertions passed"
}
ok: [molecule-test-vm-ubuntu22] => {
    "changed": false,
    "msg": "All assertions passed"
}

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Verifier completed successfully.
INFO     Running default > destroy

PLAY [Destroy] *****************************************************************

TASK [Cleanup inventory file] **************************************************
changed: [molecule-test-vm-ubuntu20]
changed: [molecule-test-vm-ubuntu22]
changed: [molecule-test-vm-ubuntu18]

TASK [Remove VMs from Azure] ***************************************************
ok: [molecule-test-vm-ubuntu22] => (item={'image': 'ubuntu-18.04', 'name': 'molecule-test-vm-ubuntu18'})
ok: [molecule-test-vm-ubuntu20] => (item={'image': 'ubuntu-20.04', 'name': 'molecule-test-vm-ubuntu20'})
ok: [molecule-test-vm-ubuntu20] => (item={'image': 'ubuntu-22.04', 'name': 'molecule-test-vm-ubuntu22'})

PLAY RECAP *********************************************************************
molecule-test-vm-ubuntu18     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu20     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
molecule-test-vm-ubuntu22     : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

INFO     Pruning extra files from scenario ephemeral directory
```

## Zusätzliche Lebenszyklus-Szenarien
Im obigen Demo sehen wir `idempotence`, das in einigen Fällen sehr wichtig ist. Sie können solche Szenarien in `molecule.yml` einfügen. Auf diese Weise teilen wir Ansible mit, das Ansible noch einmal auszuführen, um sicherzustellen, dass unsere Rolle die Kriterien für die `Idempotenz` erfüllt. Weitere Informationen zu Szenarien finden Sie unter [molecule-scenarios](https://ansible.readthedocs.io/projects/molecule/configuration/#scenario).

## Fazit
Herzlichen Glückwunsch! Sie haben erfolgreich eine Ansible-Rolle mit Molecule eingerichtet und getestet. Wir haben die Grundlagen und Test-Szenarien auf verschiedenen Ubuntu-Versionen behandelt. Erkunden Sie weiter und wenden Sie Molecule auf Ihre Ansible-Projekte an, um robuste und zuverlässige Rollen zu erstellen.

Zusätzliche Ressourcen:
* [Molecule Documentation](https://ansible.readthedocs.io/projects/molecule/)
* [Ansible Galaxy](https://ansible.readthedocs.io/projects/galaxy-ng/en/latest/community/userguide/)
* [Hetzner ansible module](https://docs.ansible.com/ansible/latest/collections/hetzner/hcloud/server_module.html)

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Harshavardhan Musanalli<harshavmb@gmail.com>

-->