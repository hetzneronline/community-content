## Introduction

pfSense is a powerful firewall and NAT which can use used to allocate multiple virtual machines and LXC containers to one dedicated IP address without the need to order any additional ones for each Virtual Machine. This tutorial teaches you how to setup a Proxmox and pfSense network configuration with simplicity and ease.

#### Prerequisites
* You're logged into the server as root or a sudo user via SSH.
*  You have an additional IP address along with the main IP address for your server.
* Proxmox is installed on the server. There is a Hetzner Community article on how to do this [here](https://community.hetzner.com/tutorials/install-and-configure-proxmox_ve) if you do not already have it installed.
* If you do not have Proxmox already installed, follow the Hetzner Community tutorial up to **step 1.4** - After this includes the network configuration section which is what we're doing here. If you have made any changes to the networking configuration, you should be safe following this tutorial as changes there will be over written with changes we make.
* Fairly average networking knowledge is recommended, although not required, it will make life a lot easier!


### Step 1.0 - Preparing the network configuration.
1) Get the name of the main network interface. In my case, it was`` enp35s0``, but it may be different for you. You can get it using the ``ip a`` command.

2) Get your server's IP address and gateway. You can get this from the Robot interface by hovering your cursor over the main server's IP address. Take note of both of these, you're going to need them later.

3) Rename your current interfaces file to ``interfaces.old``, create a new interfaces file and open it in your choice text editor. In this case I'll be using nano and the commands to do this have been left below.

``sudo mv /etc/network/interfaces /etc/network/interfaces.old`` - I recommend you rename it to interfaces.old in the unlikely case you need to backup to the old version.

``sudo touch /etc/network/interfaces`` - This creates a new interfaces file which you will be working with.

``sudo nano /etc/network/interfaces`` - This opens the file in a text editor called nano.

4) Copy the template below and paste it into your interfaces file. Replace ``<network interface>`` with the server interface name you got from part 1, in my case it was ``enp35s0``. Replace ``<server ip>`` with the server's IP address and lastly, replace ``<server gateway>`` with the gateway you got from the Robot interface.


```
auto lo
iface lo inet loopback
iface lo inet6 loopback

iface <network interface> inet manual

auto vmbr0 #Main network interface for the server.
iface vmbr0 inet static
	address  <server ip>
	netmask  255.255.255.255
	gateway  <server gateway>
	bridge-ports <network interface>
	bridge-stp off
	bridge-fd 0
	pointopoint <server gateway>
        up ip route add 192.168.0.0/16 via <server ip> dev vmbr0
        up ip route add 172.16.0.0/12 via <server ip> dev vmbr0
        up ip route add 10.0.0.0/8 via <server ip> dev vmbr0
        up sysctl -w net.ipv4.ip_forward=1
        up sysctl -w net.ipv4.conf.<network interface>.send_redirects=0


auto vmbr1 #pfSense virtual local network.
iface vmbr1 inet manual
	bridge-ports none
	bridge-stp off
	bridge-fd 0

```
5) Once you have done this and verified that the information you have filled into the template is correct, exit from nano using  "CTRL+X" and click the letter "y" on your keyboard to save the file. Once you've exited nano and you're back in the command line environment, restart the server. This can easily be done by simply typing ``reboot``. After being disconnected from your SSH session, wait a few minutes and try to reconnect. If you can reconnect, congratulations! It worked and you can move onto the next section.

### Step 1.1 - Preparing the pfSense virtual machine.
1) Firstly, navigate to the folder for Proxmox storage where ISO images are stored. By default, the location for this folder is ``/var/lib/vz/template/iso`` and you can navigate there with the command ``cd /var/lib/vz/template/iso``

2) Next, go to the pfSense website [here](https://www.pfsense.org/download/) and select the architecture as "AMD64", the Installer as "CD Image (ISO) Installer" and optionally, set the mirror as "Frankfurt, Germany". When you have done this, right click the download button and copy the link address. It should look something like ``https://frafiles.pfsense.org/mirror/downloads/pfSense-CE-x.x.x-RELEASE-p1-amd64.iso.gz`` when done.

3) Back in the SSH window, download the file to the server using the link you acquired from the pfSense download. This can be done using the ``curl`` command as shown below for example:
``curl -o pfsense.gz https://frafiles.pfsense.org/mirror/downloads/pfSense-CE-x.x.x-RELEASE-p1-amd64.iso.gz`` replacing the example pfSense download link with the link you got from the pfSense website.

4) Once you have done this, verify that the file has been downloaded using the ``ls`` command. This command will list the contents of the folder you're in, and should list ``pfsense.gz``
If you see ``pfsense.gz`` in the folder, extract the contents using the command ``gunzip pfsense.gz`` and then rename pfsense to pfsense.iso with the following command ``mv pfsense pfsense.iso``

5) Login to the Proxmox web interface by navigating to ``https://<10.0.0.0>:8006`` replacing ``<10.0.0.0>`` with your server's IP address. You should be able to login with the details you already have.

6) Navigate to the top right corner of the screen, and select "Create VM". In the box that appears, set the VM ID as 1000 (Usually something high, reserving VM IDs like 100 for other virtual machines) and give the VM a name. pfSense will be fine, I usually call my pfSense VMs ``pfSense.121`` with 121 being the ending of my additional IP. Preferentially, you can check the "Start at boot." box so the VM is started when the server is booted up so you do not manually need to do it. After you have added the information, you can go to the next page.

7) Select the storage drop-down menu click and "local", and in the "ISO image" drop-down menu click ``pfsense.iso`` and leave the "Guest OS" section as ``Type: Linux`` as well as ``Version: 5.x - 2.6 kernel``. When you have done this click next to proceed to the next screen.

8) In the system tab, you will not need to edit anything so you can click next. Once you're in the Hard Disk tab, select "SATA" as the "Bus/Device" drop-down menu and size the "Disk size" as 8GB, clicking next once you're done.

9) In the "CPU" tab, you will be fine leaving the options as is. pfSense does not need much horse power, but if more performance is desired, you may bump up the specifications. When done, click "next".

10) In the "memory" tab, you will be fine setting the memory to 512MB. This can be increased to 768MB if you have issues, although unlikely, and once again click "next" when you have done this.

11) In the "network" tab, select the "No network device" checkbox. We will set this up later, and click "next".

12) In the confirm tab, scan over the selected options and make sure they're all correct. Once you have verified their correctness, **uncheck the "Start after created" box** and click "finish".

13) Once the virtual machine has been created, select it in the Proxmox sidebar and click the "Hardware" tab. In this tab, click "Add" and click "Network Device". Here, select the "bridge" to be "vmbr0" and uncheck the Firewall checkbox. Now, go to the Hetzner Robot interface and get a separate MAC address for your additional IP address. Once you have the separate MAC address, copy it and go back to the Proxmox web interface. Here, paste the MAC address into Proxmox's MAC address box. Once you have verified all of the information, click "add".

14) Again, click the "Add" menu and click "Network Device", and this time, select the "bridge" as "vmbr1" and uncheck the Firewall checkbox. Once you have done this, click "add". Once you have done this, you have successfully prepared the pfSense virtual machine for installation.
### Step 1.2 - Installing pfSense.

1) Boot up the virtual machine and go to the "Console" tab within Proxmox.

2) Once it has started, click on the console (To focus onto it) and click enter to go to the next screen, and enter again to install pfSense.

3) Select the key map you want and proceed. The US key map is default, so you can select "Continue with default keymap" and click enter.

4) On the next screen, select "Auto (UFS)" to automatically partition the disk and click enter. Since this is a virtual machine, no data on the host will be erased.

5) Wait for the disk to be partitioned and for pfSense to be installed. When it is done, you will have the option to manually modify the system. We don't need to do this, so select "No" and click enter. On the next screen, it will ask if you want to reboot or go to a shell, in our case we want to reboot.

6) Once the VM has rebooted, you will be asked some setup questions, answer them as follows:

```Should VLANs be set up now [y:n]?``` - Select no by clicking N on your keyboard. In this setup, we're not using VLANs.

```Enter the WAN interface name or 'a' for auto-detection``` - Select A on your keyboard; em0 should be automatically selected.

```Enter the LAN interface name or 'a' for auto-detection.``` - Again, select A on your keyboard; em1 should be automatically selected.

7) Once you have done this, you will be shown the interface assignment. There should be two interfaces, one for WAN and another for LAN. If this is the case, click Y on your keyboard.

8) After pfSense configures itself and goes to the main screen, you should see both of your interfaces; WAN and LAN. On the WAN interface, you should see your additional IPv4 address which has been automatically set via DHCP. If this is the case, it has worked! You can move onto the next step.

### Step 1.2 - Configuring pfSense.
Once pfSense is installed, most users may want to configure it so they can open ports for specific virtual machines, for example.

1) Navigate to the additional IP address in your browser, it should bring you to a login page. If it loads, proceed to step 2. If it does not load, go to the console of your virtual machine, click 8 on your keyboard to go to the pfSense shell and execute the command ``pfctl -d`` - This will temporarily disable the firewall which will allow you to connect make make further changes.

2) Login to the web interface. The default username is ``admin`` and the default password is ``pfsense``.

3) Once you're logged in, you will reach a setup screen. Once you have read the contents of the page, click "Next" and on the page after that click "Next" again (It contains Netgate support stuff which we don't need in this scenario)

4) Now you're on step 2 of the pfSense setup. For the hostname, it can really be anything you want. For simplicity and organization, I recommend you set it to something associated with your server, but it can be left as the default value. For the Domain, again, this can be anything you want it to be. You may also set it to be a domain mainly associated with your server, but again, it can be left as the default value. For the "primary" and "secondary" DNS, you can set your preferential DNS server. I like to use ``1.1.1.1`` for my primary DNS server and ``9.9.9.9`` for my secondary DNS server. If you do this, unselect the "Override DNS" checkbox.

5) On step 3 of the pfSense setup, you can select which time server and timezone is used. You can customize this to your own preferences, but in my case I am leaving the Time server hostname as the default value and selecting the Timezone to be Europe/Berlin.

6) On step 4 of the pfSense setup, you will be configuring the WAN interface. In our case, we're using DHCP so we do not need to input anything into the boxes. **This includes the MAC address; we set this manually in a previous step which requires no further configuration.** Scroll to the bottom of the page and click "Next".

7) On step 5, you will be given the option to select which Private IP range you'll be for the LAN interface. For most people, it won't matter which one you select, but in my case I selected 10.0.0.0/8 as I find it looks more aesthetically pleasing and more favorable.

8) On step 6, you can set the admin password which is used to login to the pfSense web interface. Make sure this is a strong password, you do not want other people accessing this. Once you have set a new password, and saved it in a safe place, click "next".

9) On step 7, we simply need to click the "reload" button. This will apply the new changes which we have made during setup.

10) Once the reload is done, I recommend changing the web interface port by doing the following: Click the "System" drop-down menu and click "Advanced". In the "TCP port" box, set the port to something that is never usually used by other services. I usually use port 61488 since it's easy enough to remember and is never used by other applications. Once you have set the port, scroll to the bottom of the page and click Save. When this is done, it should redirect you to the web interface with the applied port.

11) After the page has reloaded with the new web port applied, you can optionally forward the port in the firewall to make accessing the page easier. You can do this by clicking on the "Firewall" drop-down menu, clicking on the "NAT" button and clicking either of the "Add" buttons. On the page, add your web port to the "Destination port range". In my case, I fill both of the boxes with "61488" as this is the random port I usually use.

12) In the "Redirect target IP" box, add the pfSense's local IP to it. You can get this local IP address from the pfSense console in Proxmox. It may look something like "192.168.1.1/24" depending on your selected options if applicable. Discard the subnet notation on the end (/24) and input "192.168.1.1" into the "Redirect target IP" box on the web interface. Lastly, on the "Redirect target port" box, add the web port "61488" again, or whatever port you set the web interface to. This port should be the same as both ports you set in the "Destination port range".

### Step 1.3a - Finishing up.

Once you've reached this step, you have finished the setup!

To test pfSense, you can create a virtual machine or LXC container with any operating system of your choice, and allocate the "**vmbr1**" interface to it, a local IP address should be automatically assigned to it via DHCP, and may look something like "192.168.1.101". To verify internet connectivity, you may simply ping a host which responds to ICMP requests; a good example is "1.1.1.1".

### Step 1.3b - Useful things to know.

- If you have any issues accessing the web interface, you may need to temporarily disable the firewall within pfSense. To do this, go to Proxmox, go to the pfSense console and click "8" on your keyboard to go to a shell, and execute the following command: ``pfctl -d`` which will temporarily disable the firewall so you can do work without interruption.

- While it is handy and convenient to have the web interface exposed to the wide internet, try to keep it closed if you can avoid keeping it open. This is mostly for security, and although we assume you use a strong password and that pfSense's brute-force blocking mechanism is working, it's best to minimize the risk all together by keeping it closed, although it isn't the end of the world if it isn't possible, just keep safe!
