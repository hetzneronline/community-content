---
SPDX-License-Identifier: MIT
path: "/tutorials/connect-avm-fritzbox-to-pfsense-ipsec"
slug: "connect-avm-fritzbox-to-pfsense-ipsec"
date: "2021-03-06"
title: "Connect AVM FritzBox to pfSense via IPSec"
short_description: "This tutorial will connect a AVM FritzBox to a pre-existing pfSense machine"
tags: ["avm", "fritzbox", "ipsec", "pfSense", "Lang:Bash"]
author: "Markus Hupfauer"
author_link: "https://www.linkedin.com/in/markus-hupfauer-169651109/"
author_img: "https://avatars1.githubusercontent.com/u/2248537"
author_description: "Markus Hupfauer"
language: "en"
available_languages: ["en"]
---

## Introduction

The pfSense instance on hcloud will have a static public ip assigned, however a residential connection will likely change its IP address once a day. Hence IPSec very much prefers static endpoints we can "bypass" this requirement by utilizing a dynamic dns
service to keep track of our non-static public ip. There are many free and paied providers, I personally can reccomend [ddnss.de](https://ddnss.de/) as its a German company and their free service is sufficient for the requirements.

Please select a service that suits your needs, create a account and follow the providers tutorial on how to configure it with your router.

**Prerequisites**

* hcloud machine with pfSense installed (iso is available for booting)
* Dynamic DNS service

## Step 1 - Setup FritzBox with DDNS

AVM allows to select a custom (ger.: "Benutzerdefiniert") DDNS provider. This utilizes a string replacement method to custom build the string. Wether or not this is a usefull function is up for debate but has to be kept in mind.

For DDNSS.de use the following configuration:

```bash
DynDNS-Provider: Custom
Update-URL: https://www.ddnss.de/upd.php?user=<username>&pwd=<pass>&host=<domain>
Domainname: ENTER YOUR DOMAIN HERE (i.e. yoursubdomain.ddnss.de)
Username: YOUR USERNAME
Password: YOUR Password
```

![AVM DDNS](images/avm-ddns.png)

### Setup IPSec configuration on pfSense

Navigate to the admin interface of your pfSense instance, log in and goto `VPN -> IPSec -> Add P1`.

AVM does not provide very secure configuration options but they should be sufficient for personal information.

The configuration has to be set to these settings:

```bash
Key exchange version:   IKEv1
Internet protocol:      IPv4
Interface:              WAN
Remote Gateway:         yourdomain.ddnss.de

=== Phase 1 Proposal (Authentication) ===
Authentication Method:  Mutual PSK
Negotiation mode:       Aggressive
My identifier:          My IP address
Peer identifier:        Distinguished name      yourdomain.ddnss.de
Pre shared key:         CLICK ON Generate

=== Phase 1 Proposal (Encryption Algorithm) ===
Algorithm:              AES
Key lenght:             256 bits
Hash:                   SHA512
DH Group:               2 (1024 bit)
Lifetime (Seconds):     28800
```

The rest can be left as is.

Next the Phase 2 has to be configured for actual network connection.

Click on `Show Phase 2 Entries (0)`, then `Add P2` and configure the second phase as follows:

```bash
Mode:                   tunnel
Local network:          [10.0.1.0 /24]      *1
NAT/BINAT translation:  None
Remote network:         [192.168.178.0 /24] *2

=== Phase 2 Proposal (SA/Key Exchange) ===
Protocol:               ESP
Encryption Algorithms:  AES     256 bits
                        !!REST UNCHECKED!!
Hash Algorithms:        SHA512
PFS key group:          2 (1024 bit)
Lifetime:               3600                        
```

Save and click `Apply changes âœ”`

*NOTES:*

`*1` This is the private IP of your hcloud internal network. Please reffer to this [excelent tutorial](https://community.hetzner.com/tutorials/how-to-route-cloudserver-over-private-network-using-pfsense-and-hcnetworks).

`*2` This is the private network of your FritzBox usually this defaults to `192.168.178.0/24` if you changed this you have to change this accordingly.

### Host jvb1/2.mydomain.tld

Services:

* jitsi-videobridge2

### SSH keys (optional, but really recommended)

`ssh-keygen -t rsa -b 4096`

On up-to-date Windows 10 versions ssh-keygen is available within PowerShell, SSH itself too)

Import the SSH key to your project (Windows %userprofile%\.ssh\id_rsa.pub)

## Step 2 - Setup servers / DNS

Hetzner utilizes something called cloud-init. Basically it provisions a server based on a config file. This is quite neat and saves us a lot of work.

Whether you provision the servers through hcloud-cli or the web UI, use the user data (cloud-config) from below.

Provision three servers with the following configuration:

* web.mydomain.tld
  * Datacenter: closest to you
  * Image: Debian 10
  * Size: CX21
  * User data: see below
  * SSH-Key: select yours
* jvb1.mydomain.tld
  * Datacenter: closest to you
  * Image: Debian 10
  * Size: CPX41
  * User data: see below
  * SSH-Key: select yours
* jvb2.mydomain.tld
  * Datacenter: closest to you
  * Image: Debian 10
  * Size: CPX41
  * User data: see below
  * SSH-Key: select yours

```bash
#cloud-config
package_upgrade: true
runcmd:
  - curl https://download.jitsi.org/jitsi-key.gpg.key | sudo sh -c 'gpg --dearmor > /usr/share/keyrings/jitsi-keyring.gpg'
  - echo 'deb [signed-by=/usr/share/keyrings/jitsi-keyring.gpg] https://download.jitsi.org stable/' | sudo tee /etc/apt/sources.list.d/jitsi-stable.list > /dev/null
  - apt-get update
```

This updates the server's packages through apt, and the `runcmd:` part also adds the offical jitsi source to apt, so we don't have to later on :+1:.

**IMPORTANT**

This tutorial assumes you will run your Jitsi server under mydomain.tld.

If you wish to run it under a third-level domain like meet.mydomain.tld then replace occurrences of mydomain.tld throughout this guide with your desired domain.

Create an A Record (either at root level or for e.g.: meet) pointing to the IP of web.mydomain.tld. You may also create a CNAME record for the domain web.mydomain.tld pointing to mydomain.tld.

Not required but nice: Create A records for the jvb servers. You may also set rDNS for the IPs through the Cloud Console.

### Step 2.1 - Provision Jitsi on web.mydomain.tld

Make sure that cloud-init worked.

```bash
cat /var/log/cloud-init-output.log

#Result:
#[snip]
#Cloud-init v. 20.2 finished at [snip]
```

If your result is not looking like this **wait**. Cloud-init takes some time and runs in the background.

After we verified the host is up and running we can start the installation process itself.

```bash
apt-get install -y jitsi-meet
```

1. Enter your hostname (e.g.: mydomain.tld *or* meet.mydomain.tld)
2. Generate self-signed certificate

The server now is setup and runs Jitsi in a standalone configuration.

You may verify the Jitsi installation by browsing to your domain or IP address.

However this setup installed a videobridge onto the webserver. We want to stop and disable the videobridge:

```bash
systemctl stop jitsi-videobridge2.service
systemctl disable jitsi-videobridge2.service
```

The diagram above explains that the JVBs register with the XMPP component. This is "secured" by a username and password.

The user defaults to jvb and will not be changed in this tutorial (although this might be a good idea). The password is stored in the now disabled videobridge configuration.

```bash
cat /etc/jitsi/videobridge/sip-communicator.properties
```

You will need the value of JVB_SECRET later on!

### Step 2.2 - Configuration of jvb1/2.mydomain.tld

This step has to be applied to both jvb1 and jvb2 server. Nothing changes for either of them!

These servers have also been installed with the cloud-init that adds the Jitsi repository, so we can install the videobridge with:

```bash
apt-get install -y jitsi-videobridge2
```

1. Enter the hostname you entered during the installation of web.mydomain.tld (e.g.: mydomain.tld or meet.mydomain.tld)

After the installation succeeded you need to change the configuration to tell the videobridge to register with the XMPP server running on web.mydomain.tld

`nano /etc/jitsi/videobridge/config`

```yml
# Jitsi Videobridge settings

# sets the XMPP domain (default: none)
JVB_HOSTNAME=mydomain.tld

# sets the hostname of the XMPP server (default: domain if set, localhost otherwise)
JVB_HOST=

# sets the port of the XMPP server (default: 5275)
JVB_PORT=5347

# sets the shared secret used to authenticate to the XMPP server
JVB_SECRET=2G0irStJ

# extra options to pass to the JVB daemon
JVB_OPTS="--apis=,"


# adds java system props that are passed to jvb (default are for home and logging config file)
JAVA_SYS_PROPS="-Dconfig.file=/etc/jitsi/videobridge/jvb.conf -Dnet.java.sip.communicator.SC_HOME_DIR_LOCATION=/etc/jitsi -Dnet.java.sip.communicator.SC_HOME_DIR_NAME=videobridge -Dnet.java.sip.communicator.SC_LOG_DIR_LOCATION=/var/log/>
```

Do not copy this block to the server. It has generated its own default values that are okay. Replace the value of JVB_SECRET to whatever you got for JVB_SECRET on web.mydomain.tld

Next we have to change the file sip-communicator.properties

`nano /etc/jitsi/videobridge/sip-communicator.properties`

```yml
org.ice4j.ice.harvest.DISABLE_AWS_HARVESTER=true
org.ice4j.ice.harvest.STUN_MAPPING_HARVESTER_ADDRESSES=meet-jit-si-turnrelay.jitsi.net:443
org.jitsi.videobridge.ENABLE_STATISTICS=true
org.jitsi.videobridge.STATISTICS_TRANSPORT=muc
org.jitsi.videobridge.xmpp.user.shard.HOSTNAME=localhost
org.jitsi.videobridge.xmpp.user.shard.DOMAIN=auth.mydomain.tld
org.jitsi.videobridge.xmpp.user.shard.USERNAME=jvb
org.jitsi.videobridge.xmpp.user.shard.PASSWORD=2G0irStJ
org.jitsi.videobridge.xmpp.user.shard.MUC_JIDS=JvbBrewery@internal.auth.mydomain.tld
org.jitsi.videobridge.xmpp.user.shard.MUC_NICKNAME=3186e863-4ae4-4d98-aa94-b1a8a0c68791
```

Do not copy this block to the server. It has generated its own default values that are okay. You only have to follow these steps:

1. Replace the value of `org.jitsi.videobridge.xmpp.user.shard.PASSWORD` to whatever you got for JVB_SECRET on web.mydomain.tld
2. Replace the value of `org.jitsi.videobridge.xmpp.user.shard.HOSTNAME` to whatever you chose as domain on web.mydomain.tld (e.g.: mydomain.tld or meet.mydomain.tld)
3. Add the following line at the end of the file

```yml
org.jitsi.videobridge.xmpp.user.shard.DISABLE_CERTIFICATE_VERIFICATION=true
```

After you completed these procedures you can restart the videobridge service

```bash
systemctl restart jitsi-videobridge2.service
```

In order to verify that the videobridge successfully connected to web.mydomain.tld check the following log **on web.mydomain.tld**

`cat /var/log/prosody/prosody.log`

This should yield a result like:

```bash
timestamp c2s563869755370 info    Stream encrypted (TLSv1.3 with TLS_AES_256_GCM_SHA384)
timestamp c2s563869755370 info    Authenticated as jvb@auth.mydomain.tl
```

## Step 3 - Certificates

Until now the webservice is not encrypted and therefore will not work on mobile devices.

To fix this you need to run the following script (installed by default) on **web.mydomain.tld**

```bash
/usr/share/jitsi-meet/scripts/install-letsencrypt-cert.sh
```

Simply enter an email address you monitor and the script will install certbot in order to automatically issue and renew a cert for your Jitsi instance.

The script creates a cronjob that renews the certificate automatically.

## Step 4 - Firewall

Let's make it safe*ish

For host web.mydomain.tld

```bash
ufw default deny incoming
ufw allow proto tcp from any to any port 22,80,443,5222,5347 
ufw --force enable
```

For both jvb hosts

```bash
ufw default deny incoming
ufw allow proto tcp from any to any port 22,443
ufw allow proto udp from any to any port 10000
ufw --force enable
```

## Conclusion

By following this tutorial you should have three cloud servers running Jitsi, with the option of scaling up by creating additional cloud servers with videobridge.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Markus Hupfauer <markus@hupfauer.one>

-->
