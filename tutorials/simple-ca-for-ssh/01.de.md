---
SPDX-License-Identifier: MIT
path: "/tutorials/simple-ca-for-ssh/de"
slug: " Simple Certificate Authority for SSH"
date: "2020-07-02"
title: "Einrichtung einer zentralen Zertifizierngsstelle für SSH Login."
short_description: "Um Benutzern den Zugang auf einen Server zeitlich zu begrenzen bietet sich der Einzatz einer Zertifizierngsstelle an."
tags: ["Administration", "SSH", "Security", "Certificate", "Authority"]
author: "Paul Ludwig"
author_link: https://github.com/pekab0
author_img: 
author_description: "Doing stuff with servers and network."
language: "de"
available_languages: ["de"]
header_img: "header-x"
---

## Einleitung

Eine weitere Möglichkeit den SSH Zugang eines Servers abzusichern ist die Authentifizierung über eine zentrale Zertifizierngsstelle (CA). Damit ist es möglich sich auf den Server via SSH key
zu verbinden ohne diesen zuerst auf den gewünschten Server in die `~/.ssh/authorized_keys` einzutragen. Somit können die ausgestellten Zertifkate zeitlich begrenzt,
oder vorzeitig ungültig gemacht werden. Dieses Verfahren ist vorallem nützlich wenn mehrere Benutzer mehrere Server betreuen. In diesem Tutorial wird dies jedoch für einen Host-Server durchgeführt.
Für größere Setups sollte ein passendes Namensschema für Host-Keys/Zertifikate und die Client-Keys/Zertifikate vorhanden sein.

**Voraussetzungen**

#### CA-Server

* Username: `root`
* Hostname: `CA-tutorial-ca`
* Subdomain: `ca.example.com`
* CA-Key: `/etc/ssh/ca/ca_key`

#### Host-Server (soll CA-Server vertrauen)

* Username: `holu`,`root`
* Hostname: `CA-tutorial-host`
* Subdomain: `host.example.com`
* CA-Key (Public-Key): `/etc/ssh/ca_key.pub`
* SSH-Daemon Konfiguration: `/etc/ssh/sshd_config`
* Host-Zertifikat: `/etc/ssh/ssh_host_ed25519_key-cert.pub`

#### Client (soll sich auf holu@host.example.com via Zertifikat einloggen können)

* Username: `client`
* Hostname: `CA-tutorial-client`
* Subdomain: `client.example.com`
* SSH-User-Key: `/home/client/.ssh/id_ed25519.pub`
* Client-Zertifikat: `/home/client/.ssh/id_ed25519-cert.pub`

## Schritt 1 - Zertifizierungsstelle erstellen

In diesem Schritt wird ein einfaches Schlüsselpaar für den CA-Server erstellt. Dieses Schlüsselpaar dient im weiteren Verlauf zum signieren des Host- & Client-Zertifikats.
Die Zertifizierungsstelle muss theoretisch nicht im Netz verfügbar sein, da sie lediglich zum signieren dient.

Generierung des Schlüsselpaars für den CA-Server `CA-tutorial-ca`
```
root@CA-tutorial-ca ~$ mkdir /etc/ssh/ca
root@CA-tutorial-ca ~$ ssh-keygen -f /etc/ssh/ca/ca_key -t ed25519
```

Nun befinden sich im Verzeichnis `/etc/ssh/ca/` der PrivateKey `/etc/ssh/ca/ca_key` und der PublicKey `/etc/ssh/ca/ca_key.pub`

## Schritt 2 - Signierung des Host-Keys

Nun muss der Host-Key des Host-Servers `CA-tutorial-host` auf den CA-Server `CA-tutorial-ca` kopiert und signiert werden. 
Im Sinne der Übersichtlichkeit bietet es sich an, die Host-Keys/Zertifikate und die Client-Keys/Zertifikate in jeweils separaten Verzeichnissen zu speichern. 
```
root@CA-tutorial-ca ~$ mkdir -p /etc/ssh/ca/certs/hosts /etc/ssh/ca/certs/clients
```

Befindet sich nun der Host-key des Host-Servers `/etc/ssh/ssh_host_ed25519_key.pub` auf dem CA-Server im oben erstellten Verzeichnis `/etc/ssh/ca/certs/hosts`,
kann dieser nun mit folgendem Befehl signiert werden.
```
root@CA-tutorial-ca ~$ ssh-keygen -s /etc/ssh/ca/ca_key -I example_host -n host.example.com -V +52w /etc/ssh/ca/certs/hosts/ssh_host_ed25519_key.pub
```

* -s: CA-Key
* -I: HostID für CA-tutorial-host Zertifikat
* -n: Principal entspricht der IP oder Subdomain des Host-Servers `CA-tutorial-host`
* -V: Gültigkeit des ausgestellten Zertifikats

Jetzt sollte der Public Host-Key mit dem CA-Key signiert sein. Wenn dies erfolgreich war,
ist das dazugehörige Zertifikat nun unter `/etc/ssh/ca/certs/hosts/ssh_host_ed25519_key-cert.pub` auffindbar.

### Schritt 2.1 - Einrichtung des Host-Zertifikats auf Host-Server

Nun muss das im letzten Schritt erstellte Host-Zertifikat und der Public-Key der Zertifizierungsstelle `/etc/ssh/ca/ca_key.pub` auf den Host-Server kopiert werden.
Im Tutorial befinden sich beide Dateien unter folgendem Pfad: `/etc/ssh/ssh_host_ed25519_key-cert.pub` und `/etc/ssh/ca_key.pub`

Jetzt müssen beide Dateien in der SSH-Daemon Konfiguration des Host-Servers eingetragen und aktiviert werden. Dies erfolgt mit folgenden Befehlen
```
root@CA-tutorial-host ~$ echo "TrustedUserCAKeys /etc/ssh/ca_key.pub" > /etc/ssh/sshd_config.d/certificate.conf
root@CA-tutorial-host ~$ echo "HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub" >> /etc/ssh/sshd_config.d/certificate.conf
root@CA-tutorial-host ~$ systemctl restart sshd

```

Um die Standart SSH-Daemon Konfiguration möglichst übersichlich zu belassen wurde im Tutorial in eine zusätzliche Konfiguration `/etc/ssh/sshd_config.d/certificate.conf` angelegt.
Diese wird in der SSH-Daemon Konfiguration eingebunden.
```/etc/ssh/sshd_config
Include /etc/ssh/sshd_config.d/*.conf
```

## Schritt 3 - Signierung des Client-Keys

In diesem Schritt muss der SSH-User-Key des Clients `CA-tutorial-client` auf den CA-Server `CA-tutorial-ca` kopiert und signiert werden. Im Tutorial wurde der SSH-User-Key
in das im Schritt 2 erstellte Verzeichnis `/etc/ssh/ca/certs/clients` kopiert. Der SSH-User-Key kann mit folgendem Befehl signiert werden.
```
root@CA-tutorial-ca ~$ ssh-keygen -s /etc/ssh/ca/ca_key -I example_client -n holu -V +10h /etc/ssh/ca/certs/clients/id_ed25519.pub
```

* -I: ClientID für CA-tutorial-client Zertifikat
* -n: Diese Angabe festgelegt legt fest mit welchen Benutzernamen der Client sich auf dem Host anmelden kann.

Jetzt sollte der Public SSH-User-Key mit dem CA-Key signiert sein. Wenn dies erfolgreich war,
ist das dazugehörige Zertifikat nun unter `/etc/ssh/ca/certs/clients/id_ed25519-cert.pub` auffindbar.

### Schritt 3.1 - Einrichtung des Client-Zertifikats beim Client

Nun muss das im letzten Schritt erstellte Client-Zertifikat zum Client kopiert werden.
Im Tutorial befindet sich dies nun unter folgendem Pfad: `/home/client/.ssh/id_ed25519-cert.pub`

Gegebenenfalls ist es notwendig die Besitzrechte des Zertifikats `/home/client/.ssh/id_ed25519-cert.pub` anzupassen. Dies kann mit folgendem Befehl geschehen.
```
root@CA-tutorial-ca ~$ chown client:client /home/client/.ssh/id_ed25519-cert.pub
```

## Schritt 4 - Zertifikate vorzeitig ungültig machen (Optional)

Um Zertifikate ungültig zu machen muss eine `revoked_keys` Datei erstellt und in der SSH-Daemon Konfiguration des Host-Servers eingetragen werden.
Im Tutorial wurde diese Datei im Verzeichnis `/etc/ssh/ca/revoked_keys.d/` erstellt und mit folgendem Befehl in der SSH-Daemon Konfiguration eingetragen.
```
root@CA-tutorial-client ~$ mkdir /etc/ssh/ca/revoked_keys.d/ && touch /etc/ssh/ca/revoked_keys.d/revoked_keys
root@CA-tutorial-client ~$ echo "RevokedKeys /etc/ssh/ca/revoked_keys.d/revoked_keys" >> /etc/ssh/sshd_config.d/certificate.conf
root@CA-tutorial-client ~$ systemctl restart sshd
```

Um nun ein Client-Zertifikat ungülitig zu machen, sind folgende Befehle auszuführen.
```
root@CA-tutorial-client ~$ ssh-keygen -k -u -f /etc/ssh/ca/revoked_keys.d/revoked_keys /etc/ssh/ca/certs/clients/id_ed25519.pub
root@CA-tutorial-client ~$ systemctl restart sshd
```

## Fazit

Um die oben aufgeführten Schritte bei vielen Host-Servern nicht manuell durchführen zu müssen, wäre es ratsam diese Konfigurationen via Ansible oder Puppet zu automatisieren.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->
