---
SPDX-License-Identifier: MIT
path: "/tutorials/simple-ca-for-ssh/de"
slug: " Simple Certificate Authority for SSH"
date: "2020-07-02"
title: "Einrichtung einer zentralen Zertifizierngsstelle für SSH Login."
short_description: "Um Benutzern den Zugang auf einen Server zeitlich zu begrenzen bietet sich der Einzatz einer Zertifizierungsstelle an."
tags: ["Administration", "SSH", "Security", "Certificate", "Authority"]
author: "Paul Ludwig"
author_link: https://github.com/pekab0
author_img: 
author_description: "Doing stuff with servers and network."
language: "de"
available_languages: ["de"]
header_img: "header-x"
---

## Einleitung

Eine weitere Möglichkeit den SSH Zugang eines Servers abzusichern ist die gegenseitige Überprüfung von Host-Key und Client-Key über eine zentrale Zertifizierungsstelle (CA).
Damit ist es möglich sich auf den Server via SSH key zu verbinden ohne diesen zuerst auf den gewünschten Server in die `~/.ssh/authorized_keys` einzutragen.
Somit können die ausgestellten Zertifkate zeitlich begrenzt, oder vorzeitig ungültig gemacht werden. Dieses Verfahren ist vorallem nützlich wenn mehrere Benutzer mehrere Server betreuen.
In diesem Tutorial wird dies jedoch für einen Host-Server durchgeführt. Für größere Setups sollte ein passendes Namensschema für Host-Keys/Zertifikate und die Client-Keys/Zertifikate vorhanden sein.
**Dieses Tutorial wurde mit Ubuntu 20.04 getestet**

**Voraussetzungen**

#### Zertifizierungsstelle

* CA-Key (User): `/etc/ssh/ca/user/ca_user_key`
* CA-Key (Hosts): `/etc/ssh/ca/hosts/ca_host_key`

#### Host-Server (soll Zertifizierungsstelle vertrauen)

* Username: `holu`,`root`
* Subdomain: `host.example.com`
* SSH-Daemon Konfiguration: `/etc/ssh/sshd_config`
* Host-Key: `/etc/ssh/ssh_host_ed25519_key.pub`
* Host-Zertifikat: `/etc/ssh/ca/certs/hosts/ssh_host_ed25519_key-cert.pub`

#### Client (soll sich auf holu@host.example.com via Zertifikat einloggen können)
* User: `client`
* SSH-User-Key: `/home/client/.ssh/id_ed25519.pub`
* Client-Zertifikat: `/home/client/.ssh/id_ed25519-cert.pub`

## Schritt 1 - Zertifizierungsstelle auf dem Host-Server erstellen

In diesem Schritt werden einfache Schlüsselpaare für die Zertifizierungsstelle erstellt. Diese Schlüsselpaare dienen im weiteren Verlauf zum signieren von Host- & User-Zertifikaten.

Generierung der Schlüsselpaare für Zertifizierungsstelle
```
mkdir -p /etc/ssh/ca/user && mkdir /etc/ssh/ca/hosts 
ssh-keygen -f /etc/ssh/ca/user/ca_user_key -t ed25519 && ssh-keygen -f /etc/ssh/ca/hosts/ca_host_key -t ed25519
```

Nun befinden sich im Verzeichnis `/etc/ssh/ca/user`/`/etc/ssh/ca/hosts` die jeweiligen Schlüsslepaare.

## Schritt 2 - Signierung des Host-Keys

Nun muss der Host-Key des Host-Servers mit dem `ca_host_key` signiert werden. 
Im Sinne der Übersichtlichkeit bietet es sich an, die Host-Zertifikate und die Client-Zertifikate in jeweils separaten Verzeichnissen zu speichern. 
```
mkdir -p /etc/ssh/ca/certs/hosts /etc/ssh/ca/certs/clients
```

Signierung des Host-Keys `/etc/ssh/ssh_host_ed25519_key.pub` im oben erstellten Verzeichnis `/etc/ssh/ca/certs/hosts`.
```
ssh-keygen -s /etc/ssh/ca/hosts/ca_host_key -I example_host_ID -n host.example.com -V +52w /etc/ssh/ssh_host_ed25519_key.pub
mv /etc/ssh/ssh_host_ed25519_key-cert.pub /etc/ssh/ca/certs/hosts/
```

* -s: CA-Key
* -I: HostID für CA-tutorial-host Zertifikat
* -n: Principal entspricht der IP oder Subdomain des Host-Servers
* -V: Gültigkeit des ausgestellten Zertifikats

Jetzt sollte der Public Host-Key mit dem `ca_host_key` signiert sein. Wenn dies erfolgreich war,
ist das dazugehörige Zertifikat nun unter `/etc/ssh/ca/certs/hosts/ssh_host_ed25519_key-cert.pub` auffindbar.

### Schritt 2.1 - Einrichtung des Host-Zertifikats auf Host-Server

Nun muss das im letzten Schritt erstellte Host-Zertifikat und der `ca_user_key.pub` auf den Host-Server eingerichtet werden.
Im Tutorial befinden sich beide Dateien unter folgendem Pfad: `/etc/ssh/ca/certs/hosts/ssh_host_ed25519_key-cert.pub` und `/etc/ssh/ca/user/ca_user_key.pub`

Um die Standard SSH-Daemon Konfiguration möglichst übersichlich zu belassen wurde im Tutorial in eine zusätzliche Konfiguration `/etc/ssh/sshd_config.d/certificate.conf` angelegt.
Diese wird in der SSH-Daemon Konfiguration eingebunden.
```
mkdir /etc/ssh/sshd_config.d

# /etc/ssh/sshd_config
Include /etc/ssh/sshd_config.d/*.conf
```

```
echo "TrustedUserCAKeys /etc/ssh/ca/user/ca_user_key.pub" > /etc/ssh/sshd_config.d/certificate.conf
echo "HostCertificate /etc/ssh/ca/certs/hosts/ssh_host_ed25519_key-cert.pub" >> /etc/ssh/sshd_config.d/certificate.conf
systemctl restart sshd

```

## Schritt 3 - Signierung des Client-Keys

In diesem Schritt muss der SSH-User-Key des Clients `CA-tutorial-client` auf den CA-Server `CA-tutorial-ca` kopiert und signiert werden. Im Tutorial wurde der SSH-User-Key
in das im Schritt 2 erstellte Verzeichnis `/etc/ssh/ca/certs/clients` kopiert. Der SSH-User-Key kann mit folgendem Befehl signiert werden.
```
root@CA-tutorial-ca ~$ ssh-keygen -s /etc/ssh/ca/ca_key -I example_client -n holu -V +10h /etc/ssh/ca/certs/clients/id_ed25519.pub
```

* -I: ClientID für CA-tutorial-client Zertifikat
* -n: Diese Angabe festgelegt legt fest mit welchen Benutzernamen der Client sich auf dem Host anmelden kann.

Jetzt sollte der Public SSH-User-Key mit dem CA-Key signiert sein. Wenn dies erfolgreich war,
ist das dazugehörige Zertifikat nun unter `/etc/ssh/ca/certs/clients/id_ed25519-cert.pub` auffindbar.

### Schritt 3.1 - Einrichtung des Client-Zertifikats beim Client

Nun muss das im letzten Schritt erstellte Client-Zertifikat zum Client kopiert werden.
Im Tutorial befindet sich dies nun unter folgendem Pfad: `/home/client/.ssh/id_ed25519-cert.pub`

Gegebenenfalls ist es notwendig die Besitzrechte des Zertifikats `/home/client/.ssh/id_ed25519-cert.pub` anzupassen. Dies kann mit folgendem Befehl geschehen.
```
root@CA-tutorial-ca ~$ chown client:client /home/client/.ssh/id_ed25519-cert.pub
```

## Schritt 4 - Zertifikate vorzeitig ungültig machen (Optional)

Um Zertifikate ungültig zu machen muss eine `revoked_keys` Datei erstellt und in der SSH-Daemon Konfiguration des Host-Servers eingetragen werden.
Im Tutorial wurde diese Datei im Verzeichnis `/etc/ssh/ca/revoked_keys.d/` erstellt und mit folgendem Befehl in der SSH-Daemon Konfiguration eingetragen.
```
root@CA-tutorial-client ~$ mkdir /etc/ssh/ca/revoked_keys.d/ && touch /etc/ssh/ca/revoked_keys.d/revoked_keys
root@CA-tutorial-client ~$ echo "RevokedKeys /etc/ssh/ca/revoked_keys.d/revoked_keys" >> /etc/ssh/sshd_config.d/certificate.conf
root@CA-tutorial-client ~$ systemctl restart sshd
```

Um nun ein Client-Zertifikat ungülitig zu machen, sind folgende Befehle auszuführen.
```
root@CA-tutorial-client ~$ ssh-keygen -k -u -f /etc/ssh/ca/revoked_keys.d/revoked_keys /etc/ssh/ca/certs/clients/id_ed25519.pub
root@CA-tutorial-client ~$ systemctl restart sshd
```

## Fazit

Um die oben aufgeführten Schritte bei vielen Host-Servern nicht manuell durchführen zu müssen, wäre es ratsam diese Konfigurationen via Ansible oder Puppet zu automatisieren.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [submitter's name and email address here]

-->
