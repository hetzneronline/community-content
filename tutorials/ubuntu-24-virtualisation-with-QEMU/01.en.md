---
SPDX-License-Identifier: MIT
path: "/tutorials/bridged-and-routed-ubuntu-24-virtualisation-with-QEMU/"
slug: "bridged-or-routed-ubuntu-24-virtualisation-with-QEMU"
date: "2025-07-18"
title: "Configuring a bridged/routed IPv4 and IPv6 in Ubuntu 24 for virtualisation with QEMU"
short_description: "Configuring a bridged/routed IPv4 and IPv6 in Ubuntu 24 for virtualisation with QEMU."
tags: ["IPv4", "IPv6", "QEMU", "Virtualisation", "Ubuntu 24"]
author: "VinkPa"
author_link: "https://github.com/VinkPa"
author_img: "https://avatars.githubusercontent.com/vinkpa"
author_description: ""
language: "en"
available_languages: ["en"]
header_img: "header-6"
cta: "root-server"
---

# Configuring a bridged IPv4 in Ubuntu 24 for virtualisation with QEMU

**Note**: The start command shown in the example is for illustrative purposes only and does not constitute instructions. Unfortunately, we cannot offer support for setting up or operating a virtualization environment.

**Prerequisits:**
- Server has 1 physical uplink interface - enp7s0 with MAC address AA:BB:CC:DD:EE:FF
- Server has main IPv4 (enp7s0)
- Server has 1x additional single IPv4 (virtual MAC address 00:50:56:00:11:22 was already assigned via Robot account)
- Server has a /64 IPv6 subnet for the HOST
- We use regular qemu in console for this example scenario


**Example terminology**

```bash
2001:db8:1234::   # Placeholder for public IPv6 network of the server
10.0.0.168        # Placeholder for main IPv4
10.0.10.135       # Placeholder for additional single IPv4
10.10.10.128/29   # Placeholder for additional IPv4 Network
AA:BB:CC:DD:EE:FF # Placeholder for MAC address of physical interface and main IPv4
00:50:56:00:11:22 # Placeholder for virtual MAC address of additional single IP address
```

## Goal:
- HOST:
  - keeps its main IPv4
  - receives IPv6::2/64
- GUEST:
  - receives the additional single IPv4 address in bridged mode
  - no IPv6, because the subnet is assigned to the main IPv4 Address

## Implementation:
- 1 virtual bridge that takes control of the main interface (bridged to enp7s0)


## Step 1 - Configure Netplan on HOST
`nano /etc/netplan/01-netcfg.yaml`
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    enp7s0:
      dhcp4: no
      dhcp6: no
  bridges:
    vibr0:
      interfaces: [enp7s0]
      macaddress: AA:BB:CC:DD:EE:FF # MAC address of the physical network interface of the HOST uplink
      addresses:
        - 10.0.0.168/32          # Main IPv4 for the HOST
        - 2001:db8:1234::2/64    # Main IPv6/64 subnet for the HOST
                                 # Additional IP for the VM is not configured on HOST
      routes:
        - on-link: true
          to: 0.0.0.0/0
          via: 10.0.0.129        # Gateway IPv4 of the main IPv4 address
        - to: default
          via: fe80::1           # Default Hetzner IPv6 gateway
      nameservers:
        addresses:
          - 185.12.64.2          # Nameservers from installimage process
          - 2a01:4ff:ff00::add:1 # Nameservers from installimage process
          - 185.12.64.1          # Nameservers from installimage process
          - 2a01:4ff:ff00::add:2 # Nameservers from installimage process
```

## Step 2 - Configure tap interface on HOST to connect HOST and GUEST

Important note: This is not persistent across reboots.
```bash
ip tuntap add dev tap0 mode tap user $(whoami)
ip link set tap0 up
ip link set tap0 master vibr0
```

To make this persistent, you can utilize a service file:
`nano /etc/systemd/system/tap0.service`

```bash
[Unit]
Description=Persistent tap0 interface
After=network-pre.target
Before=network.target
Wants=network.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/ip tuntap add dev tap0 mode tap user root
ExecStartPost=/usr/sbin/ip link set tap0 up
ExecStartPost=/usr/sbin/ip link set tap0 master vibr0
ExecStop=/usr/sbin/ip link set tap0 down
ExecStopPost=/usr/sbin/ip tuntap del dev tap0 mode tap
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```
```bash
systemctl daemon-reload
systemctl enable tap0.service
```
Important note: The service example defines the user `root`. Please adjust the user to match the user who will later run the VM in production use.
**Possible change:? Please change the user to the person who should be root for the future.** 


## Step 3 - Start VM
```bash
qemu-system-x86_64 \
  -enable-kvm \
  -smp 4            `### 4 CPU cores` \
  -m 4096           `### 4GB RAM` \
  -cpu host         `### Use the native CPU architecture` \
  -hda vm0.vpc      `### Virtual HDD file for the OS in this case` \
  -usbdevice tablet `### Emulate USB tablet for HID input (optional)` \
  -k en-us          `### Keyboard layout (optional)` \
  -vnc 127.0.0.1:1  `### Launch VNC for visualistation (optional) - Please set up an encrypted tunnel to not expose the unencrypted VNC connection!` \
  -monitor stdio    `### Launch qemu in interactive mode - Allow adjustments to the VM on the fly)` \
  -netdev tap,id=net0,ifname=tap0,script=no,downscript=no   `### Assign a network device to the VM via the tap0 you created earlier` \
  -device virtio-net-pci,netdev=net0,mac=00:50:56:00:11:22  `### Directly start the VM with the correct virtual MAC to prevent abuse due to unallowed mac`
```


## Step 4 - Configure netplan of GUEST
`nano /etc/netplan/01-netcfg.yaml`
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens3:                           # Network identifier of the VM according to predictable naming scheme
      macaddress: 00:50:56:00:11:22 # MAC address of the physical network interface of the HOST uplink
      addresses:
        - 10.0.10.135/32            # The single IPv4 dddress for the GUEST
                                    # No IPv6 - IPv6 net is assigned to physical mac address
      routes:
        - to: default               # Default 0.0.0.0/0 route
          via: 10.0.0.129           # Gateway of the single IPv4
          on-link: true             # Required for IPv4/32 configuration
      nameservers:
        addresses:
          - 185.12.64.1             # Nameservers from installimage process
          - 185.12.64.2             # Nameservers from installimage process
```

The bridged setup does not allow the use of the main IPv6 /64 subnet in both the host and the VM. The IPv6 subnet is routed to exactly one IPv4 via its unique MAC address. You can change the routing target on your Robot account.

Log onto to your Hetzner Robot account. Then go to Servers > [select your server] > IPs

As soon as you have at least 2 IPv4 addresses with an assigned MAC address, you can see a small button after the IPv6 subnet, which allows you to set a target mac address. If you adjust it to your additional IPv4, you can use your IPv6 subnet in your GUEST, but no longer on the HOST.




# Configuring a routed IPv4 and IPv6 in Ubuntu 24 for virtualisation with QEMU

**Note**: The start command shown in the example is for illustrative purposes only and does not constitute instructions. Unfortunately, we cannot offer support for setting up or operating a virtualization environment.

**Prerequisits:**
- Server has 1 physical uplink interface - enp7s0 with MAC address AA:BB:CC:DD:EE:FF
- Server has main IPv4 (enp7s0)
- Server has 1x additional single IPv4 (virtual MAC address was disabled via Robot account)
- OR Server has 1x additional IPv4 aubnet - A single IPv4 in a routed configuration is functionally just a /32 subnet.
- Server has a /64 IPv6 subnet for the HOST and GUEST
- We use regular qemu in console for this example scenario

**Example terminology**

```bash
2001:db8:1234::   # Placeholder for public IPv6 network of the server
10.0.0.168        # Placeholder for main IPv4
10.0.10.135       # Placeholder for additional single IPv4
10.10.10.128/29   # Placeholder for additional IPv4 Network
AA:BB:CC:DD:EE:FF # Placeholder for MAC address of physical interface and main IPv4
00:50:56:00:11:22 # Placeholder for virtual MAC address of additional single IP address
```

## Goal:
- HOST:
  - keeps its main IPv4
  - receives IPv6::2/64
- GUEST:
  - receives the additional single IPv4 address in routed mode
  - receives IPv6::3/64

## Implementation:
- 1 virtual bridge that takes control of the main interface (NOT bridged to enp7s0)


## Step 1 - Configure Netplan on HOST
`nano /etc/netplan/01-netcfg.yaml`
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    enp7s0:
      addresses:
        - 10.0.0.168/32           # Main IPv4 for the HOST
        - 2001:db8:1234::2/64     # Main IPv6/64 subnet for the HOST
      routes:
        - on-link: true
          to: 0.0.0.0/0
          via: 10.0.0.129         # Gateway IPv4 of the main IPv4 address
        - to: default
          via: fe80::1            # Default Hetzner IPv6 gateway
      nameservers:
        addresses:
          - 185.12.64.2           # Nameservers from installimage process
          - 2a01:4ff:ff00::add:1  # Nameservers from installimage process
          - 185.12.64.1           # Nameservers from installimage process
          - 2a01:4ff:ff00::add:2  # Nameservers from installimage process
  bridges:
    vibr0:
      interfaces: []              # Bridge not connected to enp7s0
      addresses:
        - 10.0.0.168/32            # Main IPv4 for the HOST
        - 2001:db8:1234::2/64      # Main IPv6/64 subnet for the HOST
      routes:
        - to: 10.0.10.135/32       # Route for the additional IPv4 (or whole IPv4 subnet)
          scope: host              # Required, so netplan creates a local route
        - to: 2001:db8:1234::3/128 # Route for the IPv6 of the VM
          scope: host              # Required, so netplan creates a local route
```
Netplan will by default not create a route for local connections.
`scope: host` forces netplan to create a route anyways.
This is identical to `/etc/network/interfaces` `post-up ip route add 10.0.10.135/32 dev vmbr0`


## Step 2 - Configure tap interface on HOST to connect HOST and GUEST

Important note: This is not persistent across reboots.
```bash
ip tuntap add dev tap0 mode tap user $(whoami)
ip link set tap0 up
ip link set tap0 master vibr0
```

To make this persistent, you can utilize a service file:
`nano /etc/systemd/system/tap0.service`
```bash
[Unit]
Description=Persistent tap0 interface
After=network-pre.target
Before=network.target
Wants=network.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/ip tuntap add dev tap0 mode tap user root
ExecStartPost=/usr/sbin/ip link set tap0 up
ExecStartPost=/usr/sbin/ip link set tap0 master vibr0
ExecStop=/usr/sbin/ip link set tap0 down
ExecStopPost=/usr/sbin/ip tuntap del dev tap0 mode tap
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```
systemctl daemon-reload
systemctl enable tap0.service

Important note: The service example defines the user root. Please adjust the user to match the user, who runs the VM in production later
**Same note as above**

## Step 3 - Enable IP forwarding
```bash
sysctl -w net.ipv4.ip_forward=1
sysctl -w net.ipv6.conf.all.forwarding=1
```

To make these changes persistent across reboots, add these 2 lines to `/etc/sysctl.d/99-forwarding.conf`:
```
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1
```

*If* iptables blocks IP forwarding, please allow it:
```bash
iptables -A FORWARD -i vibr0 -j ACCEPT
iptables -A FORWARD -o vibr0 -j ACCEPT
ip6tables -A FORWARD -i vibr0 -j ACCEPT
ip6tables -A FORWARD -o vibr0 -j ACCEPT
```
This is not required for the Hetzner standard image of Ubuntu 24


## Step 4 - Start VM
```
qemu-system-x86_64 \
  -enable-kvm \
  -smp 4            `### 4 CPU cores` \
  -m 4096           `### 4GB RAM` \
  -cpu host         `### Use the native CPU architecture` \
  -hda vm0.vpc      `### Virtual HDD file for the OS in this case` \
  -usbdevice tablet `### Emulate USB tablet for HID input (optional)` \
  -k en-us          `### Keyboard layout (optional)` \
  -vnc 127.0.0.1:1  `### Launch VNC for visualistation (optional) - Please set up an encrypted tunnel to not expose the unencrypted VNC connection` \
  -monitor stdio    `### Launch qemu in interactive mode - Allow adjustments to the VM on the fly)` \
  -netdev tap,id=net0,ifname=tap0,script=no,downscript=no   `### Assign a network device to the VM via the tap0 created earlier` \
  -device virtio-net-pci,netdev=net0                        `### Start VM without MAC - routing prevents random mac from leaking - no abuse`
```


## Step 5 - Configure netplan of GUEST
`nano /etc/netplan/01-netcfg.yaml`
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens3:                       # Network identifier of the VM according to predictable naming scheme
      addresses:
        - 10.0.10.135/32        # The single IPv4 Address for the GUEST
        - 2001:db8:1234::3/128  # A free IP of the IPv6 Subnet
      routes:
        - to: default           # Default 0.0.0.0/0 route
          via: 10.0.0.168       # Main IPv4 is the gateway for the IPv4 (or subnet)
          on-link: true         # Required for IPv4/32 configuration
        - to: default           # Default IPv6 route
          via: 2001:db8:1234::2 # HOST IPv6 as gateway
          on-link: true         # Required for IPv4/32 configuration
      nameservers:
        addresses:
          - 185.12.64.1          # Nameservers from installimage process
          - 2a01:4ff:ff00::add:2 # Nameservers from installimage process
          - 185.12.64.2          # Nameservers from installimage process
          - 2a01:4ff:ff00::add:1 # Nameservers from installimage process
```

Routed setups allow you to use your free IPv6 /64 subnet for multiple virtual machines and your host simultaneously without conflicting MAC addresses. You can also use a routed setup to spread IPv4 subnets across multiple machines.
