---
SPDX-License-Identifier: MIT
path: "/tutorials/install-almalinux-10-with-full-disk-encryption/de"
slug: "install-almalinux-10-with-full-disk-encryption"
date: "2025-03-12"
title: "Anleitung zur Installation eines voll verschluesselten AlmaLinux 10"
short_description: "Dieses Tutorial zeigt, wie man ein voll verschl√ºsseltes AlmaLinux 10 via installimage und Entsperrung mit SSH installiert."
tags: ["AlmaLinux", "installimage", "encryption", "dracut-sshd", "FDE", "SSH", "initramfs"]
author: "Nils"
author_link: "https://github.com/byreqz"
author_img: "https://avatars.githubusercontent.com/u/32552517"
author_description: ""
language: "de"
available_languages: ["en", "de"]
header_img: "header-6"
cta: "dedicated"
---

## Einleitung

Das [installimage](https://docs.hetzner.com/de/robot/dedicated-server/operating-systems/installimage/) Skript in dem [Hetzner Rescue System](https://docs.hetzner.com/de/robot/dedicated-server/troubleshooting/hetzner-rescue-system/) bietet eine einfache M√∂glichkeit, verschiedene Linux-Distributionen zu installieren.

Dieses Tutorial zeigt, wie man mit `installimage` ein verschl√ºsseltes AlmaLinux 10 installiert und eine Entschl√ºsselung per SSH (dracut-sshd) im initramfs hinzuf√ºgt, das in einer separaten `/boot`-Partition gespeichert ist. Das Tutorial basiert auf der [Anleitung f√ºr FDE unter Ubuntu](https://community.hetzner.com/tutorials/install-ubuntu-2404-with-full-disk-encryption).

Dieses Tutorial verwendet zwei Beispieldateien:

| Datei                  | Beschreibung |
| ---------------------- | ------------ |
| `/tmp/setup.conf`      | Eine Konfigurationsdatei, die AlmaLinux 10 installiert und eine verschl√ºsselte root-Partition einrichtet. |
| `/tmp/post-install.sh` | Ein Bash-Skript, das auf dem System ausgef√ºhrt wird, sobald der Installationsprozess beendet ist. Das Skript richtet dracut-sshd ein, damit du dich w√§hrend dem Boot damit verbinden und die verschl√ºsselte root-Partition entschl√ºsseln kannst. |

**Voraussetzungen**

* Hetzner-Konto
* Server welcher in das Rescue-System gebootet ist und eine IPv4 Adresse besitzt
* √ñffentlicher RSA, ECDSA oder ED25519 SSH-Schl√ºssel
* Keine privaten Netzwerke √ºber die Hetzner Cloud an den Servern angeschlossen

> Bei Servern welche nur eine IPv6 Adresse besitzen muss die Konfiguration √ºber einen vollen Networkprovider (z.B. systemd-networkd oder NetworkManager) durchgef√ºhrt werden da der IP Parameter des Kernels nur IPv4 und nur Gateways im gleichen Netz unterst√ºtzt.

**Hinweis: Diese Anleitung ist explizit nur f√ºr AlmaLinux 10 geschrieben. Es k√∂nnte sein, dass diese nicht auf anderen Distributionen funktioniert.**

## Schritt 1 - Erstellen oder Kopieren des √∂ffentlichen SSH-Schl√ºssels

Es wird ein SSH-Schl√ºssel ben√∂tigt, um das verschl√ºsselte System w√§hrend dem Boot aus der Ferne entsperren zu k√∂nnen. Dieser Schl√ºssel wird auch f√ºr die sp√§tere Anmeldung am gebooteten System verwendet.

> Falls das Rescuesystem bereits mit hinterlegten SSH-Schl√ºsseln gestartet wurde kann kann auch direkt der Pfad `/root/.ssh/authorized_keys` in installimage genutzt werden.

Wenn du keinen solchen Schl√ºssel hast, musst du einen auf deinem lokalen Ger√§t generieren. **Wir empfehlen die Nutzung von ED25519 oder ECDSA Schl√ºsseln**

Um z. B. einen ED25519-Schl√ºssel zu erzeugen, f√ºhre folgenden Befehl auf dem lokalen Ger√§t aus:

```bash
ssh-keygen -t ed25519
```

Speichere den √∂ffentlichen Key des SSH-Key-Paares in der `/tmp/authorized_keys`-Datei auf dem Server. Der Server sollte bereits im Rescue System sein. Erstelle die Datei entweder direkt auf dem Server oder kopieren den √∂ffentlichen Key vom lokalen Ger√§t mit `scp`:

```bash
scp ~/.ssh/id_ed25519.pub root@<your-host>:/tmp/authorized_keys
```

## Schritt 2 - Erstellen oder Kopieren der installimage-Konfigurationsdatei

Wenn das `installimage` Skript auf einem Server im Rescue-System ohne Optionen aufgerufen wird, startet es im interaktiven Modus. Man muss ein Distributionsimage ausw√§hlen und anschlie√üend wird ein Editor ge√∂ffnet. Nach dem Verlassen des Editors, wird die Installation fortgesetzt und die entsprechende Konfiguration wird als `/installimage.conf` im installierten System gespeichert.

Wenn das `installimage` Skript auf einem Server im Rescue-System mit Optionen aufgerufen wird, startet es im automatischen Modus ‚Äî das hei√üt die Installation wird ohne interaktive Prompts ausgef√ºhrt. Folgend wird erkl√§rt, wie man eine eigene Konfigurationsdatei erstellt und diese an den Befehl `installimage` √ºbergibt, um sie w√§hrend des automatischen Installationsprozesses zu verwenden.

Erstelle eine neue Konfigurationsdatei `/tmp/setup.conf` und f√ºge folgenden Inhalt ein:

> Hinweis: Ersetze `secret` durch ein sicheres Passwort und passe die Laufwerksnamen und die Partitionierung nach Bedarf an.

```bash
CRYPTPASSWORD secret
DRIVE1 /dev/sda
BOOTLOADER grub
HOSTNAME host.example.com
PART /boot/efi esp 256M
PART /boot ext4 1G
PART /     ext4 all crypt
IMAGE /root/images/Alma-1001-amd64-base.tar.gz
SSHKEYS_URL /tmp/authorized_keys
```

> **Hinweis:** Es sollte auch RockyLinux 10 (`Rocky-1001-amd64-base.tar.gz`) oder CentOS Stream 10 (`CentOS-1000-stream-amd64-base.tar.gz`) funktionieren ‚Äî allerdings ohne Garantie.

Diese Konfiguration installiert AlmaLinux auf einem einzelnen verschl√ºsselten Laufwerk (`/dev/sda`) mit einer separaten unverschl√ºsselten `/boot` Partition, das f√ºr die Entschl√ºsselung ben√∂tigt wird.

<br>

<details>

<summary>Beispiel f√ºr zwei Laufwerke (RAID1)</summary>

<blockquote>

<table border="1" style="min-width:29rem;">
<tr><th style="text-align: center;">Partition</th>
    <th style="text-align: center;">Einh√§ngepunkt</th>
    <th style="text-align: center;">RAID Device</th>
    <th style="text-align: center;">RAID Level</th>
</tr>
<tr><td><kbd style="background-color:#B2D8B2;color:#000;border-radius:6px;">sda1</kbd>
        <kbd style="background-color:#f3ccd4;color:#000;border-radius:6px;">sdb1</kbd>
    </td>
    <td><kbd style="background-color:#CCCCCC;color:#000;border-radius:6px;">/boot/efi</kbd>
    <td><kbd>md0</kbd></td>
    <td>1</td>
</tr>
<tr><td><kbd style="background-color:#B2D8B2;color:#000;border-radius:6px;">sda2</kbd>
        <kbd style="background-color:#f3ccd4;color:#000;border-radius:6px;">sdb2</kbd>
    </td>
    <td><kbd style="background-color:#CCCCCC;color:#000;border-radius:6px;">/boot</kbd>
    <td><kbd>md1</kbd></td>
    <td>1</td>
</tr>
<tr><td><kbd style="background-color:#B2D8B2;color:#000;border-radius:6px;">sda3</kbd>
        <kbd style="background-color:#f3ccd4;color:#000;border-radius:6px;">sdb3</kbd>
    </td>
    <td><kbd style="background-color:#CCCCCC;color:#000;border-radius:6px;">/</kbd>
    <td><kbd>md2</kbd></td>
    <td>1</td>
</tr>
</table>

```bash
CRYPTPASSWORD secret
DRIVE1 /dev/sda
DRIVE2 /dev/sdb
SWRAID 1
SWRAIDLEVEL 1
BOOTLOADER grub
HOSTNAME host.example.com
PART /boot/efi esp 256M
PART /boot ext4 1G
PART /     ext4 all crypt
IMAGE /root/images/Alma-1001-amd64-base.tar.gz
SSHKEYS_URL /tmp/authorized_keys
```

</blockquote>

<br>

</details>

<details>

<summary>Beispiel f√ºr vier Laufwerke (RAID10)</summary>

<blockquote>

<table border="1" style="min-width:29rem;">
<tr><th style="text-align: center;">Partition</th>
    <th style="text-align: center;">Einh√§ngepunkt</th>
    <th style="text-align: center;">RAID Device</th>
    <th style="text-align: center;">RAID Level</th>
</tr>
<tr><td><kbd style="background-color:#B2D8B2;color:#000;border-radius:6px;">sda1</kbd>
        <kbd style="background-color:#f3ccd4;color:#000;border-radius:6px;">sdb1</kbd>
        <kbd style="background-color:#d4ccf3;color:#000;border-radius:6px;">sdc1</kbd>
        <kbd style="background-color:#c5e4ed;color:#000;border-radius:6px;">sdd1</kbd>
    </td>
    <td><kbd style="background-color:#CCCCCC;color:#000;border-radius:6px;">/boot/efi</kbd>
    <td><kbd>md0</kbd></td>
    <td>1</td>
</tr>
<tr><td><kbd style="background-color:#B2D8B2;color:#000;border-radius:6px;">sda2</kbd>
        <kbd style="background-color:#f3ccd4;color:#000;border-radius:6px;">sdb2</kbd>
        <kbd style="background-color:#d4ccf3;color:#000;border-radius:6px;">sdc2</kbd>
        <kbd style="background-color:#c5e4ed;color:#000;border-radius:6px;">sdd2</kbd>
    </td>
    <td><kbd style="background-color:#CCCCCC;color:#000;border-radius:6px;">/boot</kbd>
    <td><kbd>md1</kbd></td>
    <td>1</td>
</tr>
<tr><td><kbd style="background-color:#B2D8B2;color:#000;border-radius:6px;">sda3</kbd>
        <kbd style="background-color:#f3ccd4;color:#000;border-radius:6px;">sdb3</kbd>
        <kbd style="background-color:#d4ccf3;color:#000;border-radius:6px;">sdc3</kbd>
        <kbd style="background-color:#c5e4ed;color:#000;border-radius:6px;">sdd3</kbd>
    </td>
    <td><kbd style="background-color:#CCCCCC;color:#000;border-radius:6px;">/</kbd>
    <td><kbd>md2</kbd></td>
    <td>10</td>
</tr>
</table>

```bash
CRYPTPASSWORD secret
DRIVE1 /dev/sda
DRIVE2 /dev/sdb
DRIVE3 /dev/sdc
DRIVE4 /dev/sdd
SWRAID 1
SWRAIDLEVEL 10
BOOTLOADER grub
HOSTNAME host.example.com
PART /boot/efi esp 256M
PART /boot ext4 1G
PART /     ext4 all crypt
IMAGE /root/images/Alma-1001-amd64-base.tar.gz
SSHKEYS_URL /tmp/authorized_keys
```

</blockquote>

<br>

</details>

<details>

<summary>Beispiel f√ºr Volume Group (VG)</summary>

<blockquote>

```bash
CRYPTPASSWORD secret
DRIVE1 /dev/sda
DRIVE2 /dev/sdb
SWRAID 1
SWRAIDLEVEL 1
BOOTLOADER grub
HOSTNAME host.example.com
PART /boot/efi esp 256M
PART /boot ext4 1G
PART lvm vg0 all crypt
LV vg0 root / ext4 50G
LV vg0 home /home ext4 1500G
IMAGE /root/images/Alma-1001-amd64-base.tar.gz
SSHKEYS_URL /tmp/authorized_keys
```

</blockquote>

</details>

## Schritt 3 - Post-Installations-Skript erstellen oder kopieren

Um die verschl√ºsselte Partition √ºber SSH zu entsperren, m√ºssen wir einen SSH Server installieren und zum initramfs hinzuf√ºgen, das auf der unverschl√ºsselten `/boot`-Partition gespeichert ist.

Um diese zus√§tzlichen Schritte ausf√ºhren zu k√∂nnen, ben√∂tigen wir ein Post-Install-Skript f√ºr das `installimage` Skript.

Erstelle im Rescue-System eine Datei `/tmp/post-install.sh` mit folgendem Inhalt:

```bash
#!/bin/bash

add_initramfs_network() {
  if systemd-detect-virt; then # cloud servers can still use DHCP
    echo -e "kernel_cmdline=\"rd.neednet=1 ip=dhcp\"\nadd_dracutmodules+=\" network \"" > /etc/dracut.conf.d/90-network.conf
    return
  fi

  mainif="$(ip --json a show up | jq -r 'del(.[] | select(.ifname == "lo")) | .[0]')" # main network interface
  ip="$(echo $mainif | jq -r '.addr_info[0].local')" # main IP
  gw="$(ip --json n | jq -r '.[0].dst')" # gateway
  nn="$(echo $mainif | jq -r '.altnames[0]')" # interface name

  echo -e "kernel_cmdline=\"rd.neednet=1 ip=$ip::$gw:255.255.255.255::$nn:none:185.12.64.1:185.12.64.2:213.239.239.164\"\nadd_dracutmodules+=\" network \"" > /etc/dracut.conf.d/90-network.conf
}

# Update system
dnf check-update >/dev/null
dnf -y install epel-release # install EPEL repo
dnf -y install jq dracut-network dracut-sshd

# Add static network config into initramfs
add_initramfs_network

# Change the port
echo "Port 2222" >> /usr/lib/dracut/modules.d/46sshd/sshd_config
dracut -f -v '' "$(ls /lib/modules)"
```

**Wichtig:** Das Post-Installations-Skript muss ausf√ºhrbar gemacht werden:

```bash
chmod +x /tmp/post-install.sh
```

## Schritt 4 - Installation starten

Pr√ºfe vor dem Start der Installation nochmals den Inhalt der folgenden Dateien:

| Datei                  | Pr√ºfen              |
| ---------------------- | ------------------- |
| `/tmp/authorized_keys` | Dein √∂ffentlicher SSH-Schl√ºssel |
| `/tmp/setup.conf`      | Die Installationskonfiguration |
| `/tmp/post-install.sh` | Ist ausf√ºhrbar und enth√§lt das Post-Installations-Skript |


Jetzt kann die Installation mit dem folgenden Befehl gestartet werden:

```bash
installimage -a -c /tmp/setup.conf -x /tmp/post-install.sh
```

Warte, bis die Installation abgeschlossen ist, und pr√ºfe die `debug.txt`-Datei auf eventuelle Fehler.

## Schritt 5 - Installiertes System booten

Nachdem die Installation abgeschlossen ist und alle Fehler behoben wurden, kann `reboot` ausgef√ºhrt werden, um den Server neu zu starten und das neu installierte System zu booten. Man kann den Boot-Vorgang beobachten, wenn eine KVM angeschlossen ist oder √ºber die [VNC-Konsole in Hetzner Console](https://docs.hetzner.com/de/cloud/servers/getting-started/vnc-console).

Nach einiger Zeit sollte der Server auf einen Ping reagieren. √úber den Default-SSH-Port 22 sollte ein Login nicht m√∂glich sein, da die root-Partition noch verschl√ºsselt ist. Verbinde dich stattdessen √ºber Port 2222 und f√ºhre `systemd-tty-ask-password-agent` aus, um die verschl√ºsselte(n) Partition(en) zu entsperren. Wenn du dich mit dem Server verbindest, nutze den privaten Key, der zum √∂ffentlichen Key geh√∂rt, den du in `/tmp/authorized_keys` angegeben hast.

```bash
ssh -p 2222 root@<your-host>
```

**Beispiel:**

```shellsession
$ ssh -p 2222 root@<your-host>

Welcome to the early boot SSH environment. You may type

    systemd-tty-ask-password-agent

(or press "arrow up") to unlock your disks.

This shell will terminate automatically a few seconds after the
unlocking process has succeeded and when the boot proceeds.

initramfs-ssh:/root# systemd-tty-ask-password-agent
üîê Please enter passphrase for disk SAMSUNG MZVL2512HCJQ-00B00 (luks-7dfda334-4593-40af-b54e-29b9890abaf7): (press TAB for no echo)
```

Gib das Passwort an, das du zuvor in `/tmp/setup.conf` f√ºr `CRYPTPASSWORD` festgelegt hast. Wenn das Passwort korrekt ist, wird der Bootvorgang fortgesetzt und die tempor√§re SSH-Sitzung wird automatisch beendet.

Nach ein paar Sekunden kannst du dich √ºber den SSH-Port 22 mit dem Server verbinden.

```bash
ssh -p 22 root@<your-host>
```

##### License: MIT
<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Nils github@nils.lol

-->
