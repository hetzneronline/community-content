---
SPDX-License-Identifier: MIT
path: "/tutorials/distributing-ipv6-over-libvirt-guests"
slug: "distributing-ipv6-over-libvirt-guests"
date: "2022-05-13"
title: "Distributing IPv6 over libvirt guests"
short_description: "Distributing part of your IPv6 subnet over libvirt guests using bridges"
tags: ["Virtualization"]
author: "Tuxifan"
author_link: "https://gitlab.com/niansa"
author_img: "https://gitlab.com/uploads/-/system/user/avatar/2538781/avatar.png"
author_description: "A hobby C++ programmer who loves to mess with memory"
language: "en"
available_languages: ["en"]
header_img: "header-x"
cta: "product"
---

## Introduction

The first paragraph or paragraphs are there for you to explain what your tutorial will do. Please don't simply list the steps you will be following, a table of contents (TOC) with the steps will be automatically added.
Make sure users know exactly what they will end up with if they follow your tutorial, and let them know if they need any specific prerequisites.
You can link to other tutorials that your tutorial builds on, and add recommendations for what users should know.

In this tutorial you will learn how to distribute part of your pool of IPv6 addresses to your libvirt guests using bridges. This way, they will all have their own public IPv6.

**Prerequisites**

First of all, you need a dedicated server with libvirt installed as well as a /64 IPv6 subnet. This is what comes with most dedicated servers anyways.
I will assume that your machine runs Debian anything based on that, but it should be applicable to most other distros too.

What should you know before we start:

* Your IPv6 subnet address (we'll be using `2a01:4f9:3b:5193` for examples here)

## Step 1 - `Install required packages`

The only package you will need besides your existing libvirt installation is the `bridge-utils` package:

    sudo apt install bridge-utils

## Step 2 - `Create the bridge interface`

The next step is to create the bridge interface using the package we just installed:

    sudo brctl addbr br0

### Step 2.1 - `Assign it a subnet`

Next, we will assign it a /96 subnet, which is still plently. Your dedicated server most likely isn't able to run enough VMs to run out of addresses here.

    sudo ip addr add <your /64 subnet>:1:0:0:1/96 dev br0

Example:

    sudo ip addr add 2a01:4f9:3b:5193:1:0:0:1/96 dev br0

### Step 2.2 - `Set it up`

Now we can set it up (or: "enable it")

  ip link set br0 up

## Step 3 - `Add the interface to a VM`

We will now attach this bridge to a VM. To do that, run

    sudo virsh
    
And type in:

    edit --domain <name of the VM>

Now add the following entry to the `devices` node:

    <interface type='bridge'>
      <source bridge='br0'/>
      <model type='virtio'/>
      <address type='pci' domain='0x0000' bus='0x07' slot='0x00' function='0x0'/>
    </interface>
    
The interface should be hot-plugged to your VM now so it's not going to require a reboot.


## Step 4 - `Set up your VM`

You now need to set up the new network interface with the following static configuration:

    auto enp7s0
    iface enp7s0 inet6 static
      address <your /64 subnet>:1::<machine suffix>
      netmask 96
      gateway <your /64 subnet>:1::1

Example:

    auto enp7s0
    iface enp7s0 inet6 static
      address 2a01:4f9:3b:5193:1::dead
      netmask 96
      gateway 2a01:4f9:3b:5193:1::1

To do this on a Linux guest, just append these lines to your `/etc/network/interfaces` file. On a Windows guest, you will have to fill it in the Windows Settings app.

*Tip:* on Ubuntu, you might have to [use netplan instead](https://www.snel.com/support/how-to-configure-ipv6-with-netplan-on-ubuntu-18-04/)

## Step 4.1 - `Activate the config`

The final step is to activate the config by restarting the `networking` service:

    sudo systemctl restart networking

Your networking should be back up after just a few seconds. It will not interrupt your SSH session.

## Conclusion

You can now SSH into your machine using the static address you filled in! Now, you could make your bridge configuration presistent by adding it to your hosts `/etc/network/interfaces` and you could install a DHCP server to automatically assign addresses.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Tuxifan <tuxifan@posteo.de>

-->
