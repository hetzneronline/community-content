---
SPDX-License-Identifier: MIT
path: "/tutorials/ubuntu-virtualisation-with-quemu-bridged"
slug: "ubuntu-virtualisation-with-quemu-bridged"
date: "2025-10-31"
title: "Configuring a bridged IPv4 and IPv6 in Ubuntu for virtualisation with QEMU"
short_description: "This tutorial explains how to connect a host with a virtual machine (guest) on the same subnet."
tags: ["IPv4", "IPv6", "QEMU", "Virtualisation", "Ubuntu"]
author: "VinkPa"
author_link: "https://github.com/VinkPa"
author_img: "https://avatars.githubusercontent.com/u/225162162"
author_description: ""
language: "en"
available_languages: ["en", "de"]
header_img: "header-6"
cta: "dedicated"
---

## Introduction

In this tutorial, you'll learn how to set up a network configuration where the host and a virtual machine (guest) are connected through a shared bridge on the same subnet. At the end, the configuration should look like this:

<table style="background-color: transparent; border: none; min-width: 37rem;">

<tr><td style="border: none;vertical-align: top;">
        HOST:<ul>
            <li>keeps its main IPv4</li>
            <li>receives IPv6::2/64</li>
            </ul>
        </td>
    <td style="border: none;vertical-align: top;">
        GUEST:<ul>
            <li>receives the additional single IPv4 address in bridged mode</li>
            <li>no IPv6, because the subnet is assigned to the main IPv4 Address</li>
            </ul>
        </td>
    </tr>

</table>

To achieve this, we will setup one virtual bridge that takes control of the main interface (bridged to `enp7s0`).

For a routed setup (host and guest in different subnets), see [this tutorial](/tutorials/ubuntu-virtualisation-with-quemu-routed).

**Prerequisites**

- Server has 1 physical uplink interface - `enp7s0` with MAC address `AA:BB:CC:DD:EE:FF`
- Server has main IPv4 (`enp7s0`)
- Server has 1x additional single IPv4 (virtual MAC address `00:50:56:00:11:22` was already assigned via Robot account)
- Server has a `/64` IPv6 subnet for the HOST
- We use regular qemu in console for this example scenario

**Example terminology**

```bash
2001:db8:1234::   # Placeholder for public IPv6 network of the server
10.0.0.168        # Placeholder for main IPv4
10.0.10.135       # Placeholder for additional single IPv4
10.10.10.128/29   # Placeholder for additional IPv4 Network
AA:BB:CC:DD:EE:FF # Placeholder for MAC address of physical interface and main IPv4
00:50:56:00:11:22 # Placeholder for virtual MAC address of additional single IP address
```

<br>

**Note**: The start command shown in the example is for illustrative purposes only and does not constitute instructions. Unfortunately, we cannot offer support for setting up or operating a virtualization environment.

## Step 1 - Configure Netplan on HOST

```bash
nano /etc/netplan/01-netcfg.yaml
```

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    enp7s0:
      dhcp4: no
      dhcp6: no
  bridges:
    vibr0:
      interfaces: [enp7s0]
      macaddress: AA:BB:CC:DD:EE:FF # MAC address of the physical network interface of the HOST uplink
      addresses:
        - 10.0.0.168/32          # Main IPv4 for the HOST
        - 2001:db8:1234::2/64    # Main IPv6/64 subnet for the HOST
                                 # Additional IP for the VM is not configured on HOST
      routes:
        - on-link: true
          to: 0.0.0.0/0
          via: 10.0.0.129        # Gateway IPv4 of the main IPv4 address
        - to: default
          via: fe80::1           # Default Hetzner IPv6 gateway
      nameservers:
        addresses:
          - 185.12.64.2          # Nameservers from installimage process
          - 2a01:4ff:ff00::add:1 # Nameservers from installimage process
          - 185.12.64.1          # Nameservers from installimage process
          - 2a01:4ff:ff00::add:2 # Nameservers from installimage process
```

## Step 2 - Configure tap interface on HOST

Run the following commands to connect HOST and GUEST.

> This is not persistent across reboots.

```bash
ip tuntap add dev tap0 mode tap user $(whoami)
ip link set tap0 up
ip link set tap0 master vibr0
```

To make this persistent, you can utilize a service file:

```bash
nano /etc/systemd/system/tap0.service
```

```ini
[Unit]
Description=Persistent tap0 interface
After=network-pre.target
Before=network.target
Wants=network.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/ip tuntap add dev tap0 mode tap user root
ExecStartPost=/usr/sbin/ip link set tap0 up
ExecStartPost=/usr/sbin/ip link set tap0 master vibr0
ExecStop=/usr/sbin/ip link set tap0 down
ExecStopPost=/usr/sbin/ip tuntap del dev tap0 mode tap
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

```bash
systemctl daemon-reload
systemctl enable tap0.service
```

Important note: The service example defines the user `root`. Please adjust the user to match the user who will later run the VM in production use.
**Possible change:? Please change the user to the person who should be root for the future.** 

## Step 3 - Start VM

```bash
qemu-system-x86_64 \
  -enable-kvm \
  -smp 4            `### 4 CPU cores` \
  -m 4096           `### 4GB RAM` \
  -cpu host         `### Use the native CPU architecture` \
  -hda vm0.vpc      `### Virtual HDD file for the OS in this case` \
  -usbdevice tablet `### Emulate USB tablet for HID input (optional)` \
  -k en-us          `### Keyboard layout (optional)` \
  -vnc 127.0.0.1:1  `### Launch VNC for visualistation (optional) - Please set up an encrypted tunnel to not expose the unencrypted VNC connection!` \
  -monitor stdio    `### Launch qemu in interactive mode - Allow adjustments to the VM on the fly)` \
  -netdev tap,id=net0,ifname=tap0,script=no,downscript=no   `### Assign a network device to the VM via the tap0 you created earlier` \
  -device virtio-net-pci,netdev=net0,mac=00:50:56:00:11:22  `### Directly start the VM with the correct virtual MAC to prevent abuse due to unallowed mac`
```

## Step 4 - Configure netplan of GUEST

```bash
nano /etc/netplan/01-netcfg.yaml
```

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens3:                           # Network identifier of the VM according to predictable naming scheme
      macaddress: 00:50:56:00:11:22 # MAC address of the physical network interface of the HOST uplink
      addresses:
        - 10.0.10.135/32            # The single IPv4 dddress for the GUEST
                                    # No IPv6 - IPv6 net is assigned to physical mac address
      routes:
        - to: default               # Default 0.0.0.0/0 route
          via: 10.0.0.129           # Gateway of the single IPv4
          on-link: true             # Required for IPv4/32 configuration
      nameservers:
        addresses:
          - 185.12.64.1             # Nameservers from installimage process
          - 185.12.64.2             # Nameservers from installimage process
```

The bridged setup does not allow the use of the main IPv6 /64 subnet in both the host and the VM. The IPv6 subnet is routed to exactly one IPv4 via its unique MAC address. You can change the routing target on your Robot account.

Log onto to your Hetzner Robot account. Then go to Servers > [select your server] > IPs

As soon as you have at least 2 IPv4 addresses with an assigned MAC address, you can see a small button after the IPv6 subnet, which allows you to set a target mac address. If you adjust it to your additional IPv4, you can use your IPv6 subnet in your GUEST, but no longer on the HOST.

## Conclusion

After completing these steps, the host and virtual machine are successfully connected via a bridge and share the same subnet.
The host keeps its main IPv4 address and receives an individual IPv6 address from the /64 subnet, while the guest uses its dedicated IPv4 address through the bridge.
This setup allows direct communication between host and guest without requiring any additional routing configuration.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [Vincent PaÃŸler]

-->
