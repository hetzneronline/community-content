---
 SPDX-License-Identifier: MIT
 path: "/tutorials/how-to-install-matrix-synapse-element"
 slug: "how-to-install-matrix-synapse-element"
 date: "2022-12-23"
 title: "How to install Matrix Synapse server and Element Messenger with Docker and Traefik"
 short_description: "This is a tutorial describes how to install and configure your own Matrix Synapse server with Element Messenger on Docker and with Traefik as reverse proxy."
 tags: ["Matrix", "Synapse", "Element", "Docker", "Traefik"]
 author: "Claus"
 author_link: "https://github.com/LamaImPyjama"
 author_img: "https://avatars.githubusercontent.com/u/16387562?v=4"
 author_description: "Most of the time I build something, then I accidentally break it and fix it again."
 language: "en"
 available_languages: ["en"]
 header_img: ""
 cta: "cloud"
 ---

## Introduction

A full Matrix Setup consists of several components. The main component and the heart of the setup is the Matrix Synapse server which handles all chats and rooms. Synapse is an open-source Matrix server maintained by the Matrix.org Foundation.

A wide range of clients are available to access your Matrix Synapse server. On of the most used clients is Element. Element is available as an app for various platforms (iOS, Android, Windows, …) and as a web application. There is a publicly available instance at [app.element.io](https://app.element.io), but you can also self-host your own instance. In this setup, we will self-host our own instance.

In this tutorial, example.com is used as a placeholder. Replace it with your domain, otherwise your setup will not work properly!

**Prerequisites**

In the following setup, we will use Docker as the container runtime and Traefik as the reverse proxy. The installation and configuration of these two systems will not be covered in this tutorial.

For the following setup you need at least one server. For small setups and testing purposes, a CX11 with Ubuntu 22.04 will have enough power.

To access the Matrix Synapse server and the Element instance, you need two subdomains with corresponding A and AAAA records pointing to your server:

* **matrix.example.com:** Matrix Synapse server
* **element.example.com:** Element Messenger

With this deployment, we have clean usernames like "@user:example.com" while we can use a different subdomain for the Matrix Synapse server and the Element instance.

## Pre-Deployment

For the deployment create a folder (e.g /var/docker/matrix) with the following subfolders. We will use these folders as bind mounts for the corresponding container. 

```text
├── matrix
│   ├── element
│   ├── nginx
│   ├── postgres
│   └── synapse
```

#### NGINX

Since our Matrix server is hosted on a subdomain, other servers need to know where our Matrix instance is hosted. For this, create a file called "server" in the NGINX subfolder with the following content:

```json
{
    "m.server": "matrix.example.com:443"
}
```
To point the clients to out Matrix Synape server create a file called "client" in the NGINX subfolder with the following content:

```json
{
    "m.homeserver": {
        "base_url": "https://matrix.example.com:8008"
    }
}
```

#### Element
In the Element folder, create a file called "config.json" with the following content:

```json
{
    "default_server_config": {
        "m.homeserver": {
            "base_url": "https://matrix.example.com",
            "server_name": "example.com"
        },
        "m.identity_server": {
            "base_url": "https://vector.im"
        }
    },
    "disable_custom_urls": true,
    "disable_guests": true,
    "disable_login_language_selector": false,
    "disable_3pid_login": false,
    "brand": "Element",
    "integrations_ui_url": "https://scalar.vector.im/",
    "integrations_rest_url": "https://scalar.vector.im/api",
    "integrations_widgets_urls": [
        "https://scalar.vector.im/_matrix/integrations/v1",
        "https://scalar.vector.im/api",
        "https://scalar-staging.vector.im/_matrix/integrations/v1",
        "https://scalar-staging.vector.im/api",
        "https://scalar-staging.riot.im/scalar/api"
    ],
    "bug_report_endpoint_url": "https://element.io/bugreports/submit",
    "uisi_autorageshake_app": "element-auto-uisi",
    "default_country_code": "GB",
    "show_labs_settings": false,
    "features": {},
    "default_federate": true,
    "default_theme": "light",
    "room_directory": {
        "servers": ["matrix.example.com"]
    },
    "enable_presence_by_hs_url": {
        "https://matrix.org": false,
        "https://matrix-client.matrix.org": false,
        "https://matrix.example.com": true
    },
    "setting_defaults": {
        "breadcrumbs": true
    },
    "jitsi": {
        "preferred_domain": "meet.element.io"
    },
    "element_call": {
        "url": "https://call.element.io",
        "participant_limit": 8,
        "brand": "Element Call"
    },
    "map_style_url": "https://api.maptiler.com/maps/streets/style.json?key=fU3vlMsMn4Jb6dnEIFsx"
}
```

## Deployment
Create a filed called "docker-compose.yml" in the Matrix folder with the following content. Replace the network “traefik_default” with the name of your existing Traefik network and the Traefik certresolver with the name of your resolver. Use a secure password for the Postgres User. You will need this password later in the configuration of the Synapse server.

```yaml
version: "3"

services:
  db:
    image: postgres:13-alpine
    container_name: matrix_db
    restart: unless-stopped
    networks:
      - matrix
    volumes:
      - ./postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=securepassword
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    healthcheck:
      interval: 5s
      timeout: 3s
      retries: 5
    labels:
      - traefik.enable=false

  synapse:
    image: matrixdotorg/synapse:latest
    container_name: matrix_synapse
    restart: unless-stopped
    depends_on:
      - db
    networks:
      - matrix
      - traefik_default
    volumes:
      - ./synapse:/data
    healthcheck:
      interval: 5s
      timeout: 3s
      retries: 5
    labels:
      - traefik.http.routers.synapse.rule=Host(`matrix.example.com`)
      - traefik.http.routers.synapse.tls=true
      - traefik.http.routers.synapse.tls.certresolver=myresolver
      - traefik.http.services.synapse.loadbalancer.server.port=8008
 
  nginx:
    image: nginx:latest
    container_name: matrix_nginx
    volumes:
      - ./nginx:/usr/share/nginx/html/.well-known/matrix
    networks:
     - traefik_default
    healthcheck:
      interval: 5s
      timeout: 3s
      retries: 5
    labels:
      - traefik.http.routers.matrixnginx.rule=Host(`example.com`) && PathPrefix(`/.well-known/matrix`)
      - traefik.http.routers.matringinx.tls=true
      - traefik.http.routers.matrixnginx.tls.certresolver=myresolver

  element:
    image: vectorim/element-web:latest
    container_name: matrix_element
    restart: unless-stopped
    volumes:
      - type: bind
        source: ./element/config.json
        target: /app/config.json
    networks:
      - traefik_default
    healthcheck:
      interval: 5s
      timeout: 3s
      retries: 5
    labels:
      - traefik.http.routers.element.rule=Host(`element.example.com`)
      - traefik.http.routers.element.tls=true
      - traefik.http.routers.element.tls.certresolver=myresolver

networks:
  traefik_default:
    external: true
  matrix:
    internal: false
```

Save the file and create the default Matrix Synapse configuration with the following command:
`docker-compose run --rm -e SYNAPSE_SERVER_NAME=example.com -e SYNAPSE_REPORT_STATS=no synapse generate`

The configuration created can be found in the file "homeserver.yaml" located in the folder "synapse".  Open the configuration and replace “server_name” with your domain.

In addition, we need to edit the section database to use our deployed Postgres server instead of a SQLite database. Replace the password with the password set in the docker-compose file. 

```yaml
  database:
  name: psycopg2
  args:
    user: synapse
    password: securepassword
    database: synapse
    host: db
```

If you want to allow users to self register on the server, set "enable_registration=true". 
Finally, start the full stack with `docker-compose up -d`.

## First Login and Test

To register a new user manually fire the following command while the stack is running: 
`docker exec -it synapse register_new_matrix_user -c /data/homeserver.yaml https://matrix.example.com`

Now open your instance of Element Messenger running under the following URL: [https://element.example.com](https://element.example.com) and try to login. 

In order to check if the Matrix Federation is working properly, use the Matrix Federation Tester available here: [https://federationtester.matrix.org](https://federationtester.matrix.org) . Use example.com  as the domain, not matrix.example.com or anything else.



## Conclusion

A short conclusion summarizing what the user has done, and maybe suggesting different courses of action they can now take.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: [Claus - git@fidela.at]

-->
