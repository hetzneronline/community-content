---
SPDX-License-Identifier: MIT
path: "/tutorials/tutorial-template"
slug: "tutorial-template"
date: "2019-01-01"
title: "A great Tutorial Template! :+1:"
short_description: "This is a tutorial template, including metadata (the first few lines before the actual content). Please fill in as much as possible. If you dont know what to put somewhere, just leave it empty, the Community manager will fill it for you."
tags: ["Development", "Lang:Go", "Lang:JS"]
author: "Your Name"
author_link: "https://github.com/....."
author_img: "https://avatars3.githubusercontent.com/u/....."
author_description: "Manipulating arrays of characters in modern text editors that need more RAM than we used to do a flight to the moon. But it's super awesome..."
language: "it"
available_languages: ["Enter all available languages of the tutorial using ISO 639-1 codes"]
header_img: ""
---

<!-- This where the actual tutorial begins. You don't need to write out the title again, having it in the metadata above is enough. -->

## Introduction
The Generic Routing Encapsulation (GRE) is a tunneling protocol developed by Cisco Systems and can encapsulate a wide variety of network layer protocols inside a virtual point-to-point links or point-to-multipoint links over an Internet Protocol network.

### What a GRE tunnel can be used for?
A GRE tunnel is useful in certain situation, like protecting a server without DDoS protection using another one with the protection or to enable applications that only allow IPv4 to also accept IPv6.

**Prerequisites**

First of all, you must have two servers with root access.

For setting up a GRE tunnel on Linux you must have ip_gre module loaded in your kernel.
To make sure it's loaded just do:
```bash
sudo modprobe ip_gre
lsmod | grep gre
```
And you should see
```
ip_gre                 #####  0
gre                    #####  1 ip_gre
```
If you see something else it's possible that your kernel does not support GRE.


To forward all the traffic in and out of the GRE tunnel we're going to use iptables that should be already installed in all the major linux distributions.
In case it's not installed just use
```bash
sudo apt install iptables
```

## Terminology

The two server we're going to use will be called Server A and Server B, and they will have the following characteristics:

*Server A - the server that all the clients will connect to
** IP: 198.51.100.1
** GRE tunnel internal IP: 10.0.0.1
*Server B - the server which is actually running all the applications
** IP: 203.0.113.1
** GRE tunnel internal IP: 10.0.0.2

## Step 1 - Tunnel Setup

First we have to setup our tunnel.

On Server A execute this code to enable ip forwarding:
```bash
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
sysctl -p
```

Now create a new networking interface which will be the one using the GRE tunnel:
```bash
iptunnel add gre1 mode gre local 198.51.100.1 remote 203.0.113.1 ttl 255
ip addr add 10.0.0.1/30 dev gre1
ip link set gre1 up
```

Then, do the same on Server B changing the IPs:
```bash
iptunnel add gre1 mode gre local 203.0.113.1 remote 198.51.100.1 ttl 255
ip addr add 10.0.0.2/30 dev gre1
ip link set gre1 up
```

## Step 2 - Test the GRE tunnel with Ping

On Server A do:
```bash
ping 10.0.0.2
```

And on Server B do:
```bash
ping 10.0.0.1
```

If the ping works then the GRE tunnel is correctly setup.

### Step 3 - Add new routes in the route table

Route is required to make sure data that came in via the GRE tunnel is handled correctly.

On Server B execute:
```bash
echo '100 GRE' >> /etc/iproute2/rt_tables
ip rule add from 10.0.0.0/30 table GRE
ip route add default via 10.0.0.1 table GRE
```

### Step 3 - NAT for outbound connection

NAT is used to pass data over our GRE and out the other end.

On Server A run:
```bash
iptables -t nat -A POSTROUTING -s 10.0.0.0/30 ! -o gre+ -j SNAT --to-source 198.51.100.1
```

To test the outbound connection execute on Server B one of the following two group of commands:
```bash
sudo apt install curl
curl http://www.cpanel.net/showip.cgi --interface 10.0.0.2
```
```bash
sudo apt install wget
wget http://www.cpanel.net/showip.cgi --bind-address=10.0.0.2 -q -O -
```

At the end you should see the Server A's IP.

### Step 3 - Forwarding ports

On Server A run this commands to allow all the data going to and coming from Server B:
```bash
iptables -A FORWARD -d 10.0.0.2 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
iptables -A FORWARD -s 10.0.0.2 -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
```

Then, we want to forward all our data from Server A to Server B.
Execute on Server A:
```bash
/sbin/iptables -t nat -A PREROUTING -d 198.51.100.1 -p PROTO -m PROTO --dport PORT -j DNAT --to-destination 10.0.0.2
```
replacing PROTO and PORT with your actual ones.

For example, to forward all the data to a Webserver (Port TCP 80) we have to run:
```bash
/sbin/iptables -t nat -A PREROUTING -d 198.51.100.1 -p TCP -m TCP --dport 80 -j DNAT --to-destination 10.0.0.2
```
We must do it for each port we are using.

### Step 3 - Make the GRE tunnel persistent
On Server restart all the things we did will be wiped out, to make sure the GRE tunnel and everything else is going to work also after a restart we have to edit the file ```/etc/rc.local``` and add all the commands (except for the echo ones!) before the ```exit 0```.

## Conclusion

Now, if we connect to Server A using the ports we configured (Port TCP 80 for example) we're going instead to connect to the Server B without knowing it.

Note: if you use CSF to manage iptables you may have to put all the iptables commands in your ```/etc/csf/csfpost.sh``` and insert both servers IP (also the GRE one) in your ```/etc/csf/csf.allow```.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Fabrizio La Rosa lr.fabrizio@gmail.com

-->
