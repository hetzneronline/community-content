---
SPDX-License-Identifier: MIT
path: "/tutorials/howto-securing-ssh/de"
slug: "howto-securing-ssh"
date: "2019-04-19"
title: "Absicherung des SSH Dienstes"
short_description: "In diesem Beitrag geht es um die Absicherung des SSH Dienstes auf Linux Systemen."
tags: ["SSH", "Linux", "OpenSSH"]
author: "Markus"
author_link: "https://github.com/BackInBash"
author_img: "https://avatars3.githubusercontent.com/u/48181660"
author_description: ""
language: "de"
available_languages: ["de", "en"]
header_img: ""
---

# Absicherung des SSH Dienstes auf Linux Systemen 

## Einleitung
In diesem Beitrag geht es um die Absicherung des SSH Dienstes auf Linux Systemen.
Dabei werden die folgenden Punkte genauer erläutert:
+ Absicherung des SSH Dienstes
+ Zertifikatbasierter Login
+ Zwei Faktor Authentifizierung

**Voraussetzungen**
+ SSH Dienst basierend auf OpenSSH

## Step 1 - Absicherung des SSH Dienstes
Hier geht es hauptsächlich um die Anpassung der OpenSSH Konfiguration.
Alle nachfolgeden Änderungen in der SSH Konfiguraions Datei, beziehen sich auf die folgende Datei: `/etc/ssh/sshd_config`

### Step 1.1 - Deaktivieren des Root Logins
Bevor der root Login abgestellt wird, sollte man einen Administrativen Benutzer erstellen, mitdem es möglich ist root Rechte zu erlangen.

Um einen solchen User zu erstellen, genügt es die nachfolgenden Befehle auf dem System auszuführen.

```bash
useradd -m -U -s /bin/bash -G sudo holu
passwd holu
```

Jetzt kann der Root Login deaktiviert werden.
Dazu muss in der SSH Konfigurations Datei die Zeile `PermitRootLogin` wie folgt angepasst werden:

```bash
PermitRootLogin no
```
### Step 1.2 - Automatischer Sitzungs Timeout
Mit dieser Einstellung wird nach einer gewissen Inaktivität eine Zwangstrennung der SSH Verbindung vollzogen.
Dabei sind folgende Einstellungen in der SSH Konfigurations Datei notwendig:

```bash
ClientAliveInterval 300
ClientAliveCountMax 1
```

`ClientActiveInterval` definiert die maximale Zeit, in der die Sitzung inaktiv sein darf bevor sie geschlossen wird. In diesem Fall sind 300 Sekunden 5 Minuten. `ClientAliveCountMax` definiert die Anzahl der Prüfungen, die vor einer Trennung durchzuführen sind.

### Step 1.3 - Benutzer für SSH freischalten
Mit dieser Einstellung, wird es nur ausgewählten Benutzer erlaubt eine SSH Verbindung zum Server herzustellen.
Dabei sind folgende Einstellungen in der SSH Konfigurations Datei notwendig:

```bash
AllowUsers holu holu2
```

### Step 1.4 - Standard Port für SSH ändern
Mit dieser Einstellung wird der SSH Port von 22 abgeändert.

**Vorteile**: Bots und Scanner die nach SSH Diensten auf Port 22 Scannen, finden den Server nichtmehr und starten keine automatisierten Angriffe gegen den Server.

**Nachteile**: Bei jeder Verbindung muss der abgeänderte SSH Port angegeben werden.
Hier gibt es aber die Möglichkeit, die SSH Verbindung zu speichern. Auf Windows zum Beispiel mit Putty geschieht das über die Oberfläche. 
Auf Linux Clients, muss dafür die Datei `~/.ssh/config` mit folgendem Inhalt anngelegt werden.
```bash
Host <yout_host>
    HostName <your_host>
    Port AUSGEWÄHLTER_PORT
```
(Optional) Hier kann auch später der Key hinterlegt werden: `IdentityFile ~/.ssh/id_rsa`

Um die Einstellung anzuwenden, sind folgende änderungen in der SSH Konfigurations Datei notwendig:
Es ist zu empfehlen einen Port zwischen 10000 und 65535 zu wählen.
```bash
Port AUSGEWÄHLTER_PORT
```
### Step 1.5 - Die Einstellung übernehmen
Um die Einstellungen zu aktivieren, ist es nötig den SSH Dienst neuzustarten.
Zuvor sollte aber die Konfiguration auf Fehler überprüft werden, dies geschieht mit diesem Befehl:
```bash
sshd -t
```

Sollte beim überprüfen der Konfigiration keine Fehler zu erkennen gewesen sein, kann der SSH Dienst mit folgendem Befehl neugestartet werden:
```bash
systemctl restart sshd
```

## Step 2 - Einrichtung von Fail2Ban
Diese Software bietet Schutz gegen sogenannte Bute-force Angriffe.

Dabei wird nach mehrmals falsch eingegebenen Passworts, die IP Adresse des Benutzers für eine gewisse Zeit gesperrt. Das soll verhindern, dass der Angreifer eine große Kennwortliste in kurzer Zeit ausprobieren kann.

Um Fail2Ban zu Installieren sind folgende Schritte notwendig.
Installation der Software:
+ Ubuntu / Debian
   ```bash
   apt install fail2ban
   systemctl enable fail2ban
   ```
+ CentOS / RedHat
   ```bash
   yum install epel-release
   yum install fail2ban
   systemctl enable fail2ban
   ````
+ ArchLinux
   ```bash
   pacman -S fail2ban
   systemctl enable fail2ban
   ```
+ OpenSUSE / SELS
   ```bash
   zypper install fail2ban
   systemctl enable fail2ban
   ```
+ Fedora
   ```bash
   dnf install fail2ban
   systemctl enable fail2ban
   ```

Anpassen der Fail2Ban Konfiguration

Erstellen der Konfugiration anhand einer Vorlagen:
```bash
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

In der Datei `/etc/fail2ban/jail.local` müssen folgende Änderungen erfolgen:

Unter dem Reiter `[sshd]` muss `enable` auf `true` und der eventuell abgeänderte SSH Port angegeben werden.

```bash
enabled = true
port = AUSGEWÄHLTER_SSH_PORT
```
Optional können auch die Werte für:
+ `bantime` (Die Zeit in der keine weiteren Logins möglich sind.)
+ `findtime` (Die Zeit in der die fehlerhaften Login versuche gezählt werden sollen. Startet ab dem ersten fehlerhaften Login.)
+ `maxretry` (Die Maximal möglichen fehlversuche, devor es zu einer Sperrung kommt.)

abgeändert werden.

Der folgende Befehl, ist dafür die geänderte Konfiguration zu übernehmen:
```bash
systemctl restart fail2ban
```

## Step 3 - Zertifikatsbasierte Authentifizierung
Der Benutzer kann sich dadurch ohne Login-Passwort am Server anmelden, es wird ausschließlich das Passwort zum Schutz des privaten Schlüssels benötigt.

### Auf dem Client

+ Erstellen des SSH Schlüsselpaares

   __Linux / MacOS__

   Erstellen eines SSH Schlüsselpaares mit einer Bitlänge von `4096`
   ```bash
   ssh-keygen -b 4096
   ```
   Achtung: Es wird aus sicherheitstechnischen Gründen empfohlen, den Schlüssel auf jeden Fall mit einer Passphrase zu schützen. Dadurch liegt der Schlüssel nicht im Klartext vor, sondern ist AES-CBC verschlüsselt

   __Windows__

   Um auf Windowssystemen einen SSH Schlüsselpaar zu generieren, kann entweder das WSL (Windows Subsystem for Linux) oder die Software [PuttyGen](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html) verwendet werden.
+ Übertragen des Öffentlichen SSH Schlüssles auf den Server

   __Linux / MacOS__

   Für das Übertragen des öffentlichen Schlüssels auf den Server wird im ersten Schritt noch die SSH-Verbindung mittels Passwort-Authentifizierung genutzt. Das Werkzeug ssh-copy-id kopiert das entsprechende Idendity-File auf den Server:
   ```bash
   ssh-copy-id -i .ssh/id_rsa.pub holu@<your_host>
   ```

   __Windows__
   
   Auf Windowssystmen erfolgt dieser Schritt manuell, dazu kopiert man den Inhalt des öffentlichen Schlüssels in die auf dem Server befindliche Datei `/home/holu/.ssh/authorized_keys` kopieren. Es ist auch möglich, dass diese Datei zuvor erstellt werden muss.

Testen der SSH Verbindung mit Zertifikatsbasierte Authentifizierung:
```bash
ssh -i .ssh/id_rsa holu@<your_host>
```

### Auf dem Server
**Achtung:** Nach Änderung der folgenden Einstellung, ist es nicht mehr möglich, sich mit einem Passwort über ssh anzumelden: `PasswordAuthentication no`

Dafür ist die Änderung von `PasswordAuthentication yes` in `PasswordAuthentication no` an der SSH Konfiguraion unter `/etc/ssh/sshd_config` notwendig.

Es sollte auch der Eintrag `PubkeyAuthentication` überprüft werden, ob dieser auf `yes` steht und nicht auskommentiert ist.


Es ist auch möglich, die Passwort Authentifizierung für einen bestimmten Benutzer zu deaktivieren.
Der Eintrag für die SSH Konfiguraions Datei sieht wie folgt aus:
```bash
Match User holu
    PasswordAuthentication no
```
## Step 4 - Zwei Faktor Authentifizierung
Hier wird nach erfolgreichem Login nach einem Einmalpasswort verlangt, bevor der Loginvorgang abgeschlossen wird. Realisiert wird das ganze über den Google Authenticator.

>***Hinweis:*** Um die zeitbasierte Einmalpasswörter (TOTP) zu erstellen wird vorzugsweise ein Smartphone benötigt mit einer der aufgelisteten Apps.
> + [Google Authenticator](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2)
> + [andOTP](https://f-droid.org/en/packages/org.shadowice.flocke.andotp/)

### Installation des Google Authenticator:
+ Ubuntu / Debaian
   ```bash
   apt install libpam-google-authenticator
   ```
+ CentOS / RedHat
   ```bash
   yum install epel-release
   yum install google-authenticator
   ```
+ ArchLinux
   ```bash
   pacman -S libpam-google-authenticator
   ```
+ openSUSE / SELS
   ```bash
   zypper install google-authenticator-libpam
   ```
### Konfiguration des Google Authenticator:

Nachdem das PAM-Modul installiert wurde, kann es wie folgt dargestellt inititialisiert und konfiguriert werden.

Starten des Google Authenticator:
```bash
google-authenticator
```
1. `Do you want authentication tokens to be time-based (y/n)`
`y`, es werden damit TOTP Tokens erstellt (zeitbasierte Einmalpasswörter) `n`, dadurch werden HOTP Tokens erstellt (zählerbasierte Einmalpasswörter)

1. Es wird nun ein QR-Code auf der SSH-Konsole angezeigt
Scannen Sie diesen Code mit einer kompatiblen App auf Ihrem Smartphone.

1. Kopieren und verwahren Sie die unterhalb aufgelisteten Keys sicher.
Mit den emergency scratch codes kann Login ohne OTP durchgeführt werden.
Aktualisieren Sie die Datei .google_authenticator mit diesen Informationen.
Tippen Sie dazu `y` ein.

1. Bestätigen Sie sämtliche anderen Fragen mit `y`, oder bei gewünschten abweichenden Einstellungen mit `n`.

### Integration in die SSH-Anmeldung:

Das Google Authenticator PAM-Modul ist fertig konfiguriert, nun können Dienste wie der SSH-Daemon angepasst werden, um eine 2-Faktor-Authentifizierung darüber zu ermöglichen.

+ Anpassungen in `/etc/pam.d/sshd`

   Hier muss die Zeite `@include common-auth` mit einem `#` am Zeilenanfang Auskommentiert werden.
   Danach wird die Zeile `auth required pam_google_authenticator.so` eingefügt.

+ Anpassungen in `/etc/ssh/sshd_config`
   In der Konfigurationsdatei kann nun die `ChallengeResponseAuthentication` auf `yes` gesetzt werden.
   ```bash
   ChallengeResponseAuthentication yes
   ```
   Ebenso sollten die Eiträge `UsePAM` und `AuthenticationMethods` überprüft werden. der Eintrag `UsePAM` sollte auf `yes` stehen und `AuthenticationMethods` sollte so aussehen:
   ```bash
   AuthenticationMethods publickey,keyboard-interactive
   ```
+ Neustarten des SSH Dienstes
   ```bash
   systemctl restart sshd
   ```
Danach ist die Einrichtung der Zwei Faktor Authentifizierung abgeschlossen.

## Fazit
In diesem Beitrag wurde mehrere Möglichkeiten beschrieben, mit deren Hilfe man den SSH Dienst auf Linux Systemen absichern kann.

##### License: MIT

<!---

Contributors's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Markus markus@omg-network.de

-->
